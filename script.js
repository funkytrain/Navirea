// Configuración de modelos de tren
const trainModels = {
    463: {
        name: "Tren 463",
        coaches: [{
                id: "C1",
                name: "Coche 1",
                layout: [{
                        type: "seats",
                        positions: [
                            [1, 2, null, 3, 4]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [5, 6, null, 7, 8]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [9, 10, null, 11, 12]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [13, 14, null, 15, 16]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [17, 18, null, 19, 20]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [21, 22, null, 23, 24]
                        ]
                    },
                    {
                        type: "space",
                        height: 80
                    },
                    {
                        type: "seats",
                        positions: [
                            [25, 26, null, 27, 28]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [29, 30, null, 31, 32]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [33, 34, null, 35, 36]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [37, 38, null, 39, 40]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [41, 42, null, 43, 44]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [45, 46, null, 47, 48]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [49, 50, null, 51, 52]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [53, 54, null, 55, 56]
                        ]
                    },
                    {
                        type: "space",
                        height: 80
                    },
                    {
                        type: "seats",
                        positions: [
                            [57, 58, null, 59, 60]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [61, 62, null, 63, 64]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [65, 66, null, 67, 68]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [69, null, null, null, 70]
                        ]
                    },
                ],
            },
            {
                id: "C2",
                name: "Coche 2",
                layout: [{
                        type: "seats",
                        positions: [
                            [71, null, null, null, 72]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [73, 74, null, 75, 76]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [77, 78, null, 79, 80]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [81, 82, null, 83, 84]
                        ]
                    },
                    {
                        type: "space",
                        height: 80
                    },
                    {
                        type: "seats",
                        positions: [
                            [85, null, null, 86, 87]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [88, null, null, null, null]
                        ],
                    },
                    {
                        type: "seats",
                        positions: [
                            [89, null, null, 90, 91]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [92, 93, null, null, 95]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [null, null, null, null, 96]
                        ],
                    },
                    {
                        type: "pmr-bathroom",
                        height: 160
                    },
                    {
                        type: "space",
                        height: 80
                    },
                    {
                        type: "seats",
                        positions: [
                            ["PMR-97", null, null, null, "PMR-98"]
                        ],
                    },
                    {
                        type: "seats",
                        positions: [
                            [99, 100, null, 101, 102]
                        ]
                    },
                    {
                        type: "space",
                        height: 40
                    },
                    {
                        type: "seats",
                        positions: [
                            [103, null, null, null, 104]
                        ],
                    },
                    {
                        type: "seats",
                        positions: [
                            [105, null, null, null, 106]
                        ],
                    },
                ],
            },
            {
                id: "C3",
                name: "Coche 3",
                layout: [{
                        type: "seats",
                        positions: [
                            [107, null, null, null, 108]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [109, 110, null, 111, 112]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [113, 114, null, 115, 116]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [117, 118, null, 119, 120]
                        ]
                    },
                    {
                        type: "space",
                        height: 80
                    },
                    {
                        type: "seats",
                        positions: [
                            [121, 122, null, 123, 124]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [125, 126, null, 127, 128]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [129, 130, null, 131, 132]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [133, 134, null, 135, 136]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [137, 138, null, 139, 140]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [141, 142, null, 143, 144]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [145, 146, null, 147, 148]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [149, 150, null, 151, 152]
                        ]
                    },
                    {
                        type: "space",
                        height: 80
                    },
                    {
                        type: "seats",
                        positions: [
                            [153, 154, null, 155, 156]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [157, 158, null, 159, 160]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [161, 162, null, 163, 164]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [165, 166, null, 167, 168]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [169, 170, null, 171, 172]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [173, 174, null, 175, 176]
                        ]
                    },
                ],
            },
        ],
    },
464: {
    name: "Tren 464",
    coaches: [
        {
            id: "C2",
            name: "Coche 2",
            layout: [
                { type: "seats", positions: [[1, 2, null, 3, 4]] },
                { type: "seats", positions: [[5, 6, null, 7, 8]] },
                { type: "seats", positions: [[9, null, null, 10, 11]] },
                { type: "seats", positions: [[12, null, null, null, null]] },
                { type: "seats", positions: [[13, null, null, 14, 15]] },
                { type: "seats", positions: [[16, 17, null, null, 18]] },
                { type: "seats", positions: [[null, null, null, null, 19]] },
                { type: "seats", positions: [[20, 21, null, null, 22]] },
                { type: "space", height: 80 },
                { type: "seats", positions: [[23, null, null, 24, 25]] },
                { type: "seats", positions: [[26, null, null, null, null]] },
                { type: "seats", positions: [[27, null, null, 28, 29]] },
                { type: "seats", positions: [[30, 31, null, null, 32]] },
                { type: "seats", positions: [[null, null, null, null, 33]] },
                { type: "seats", positions: [[34, 35, null, null, 36]] },
                { type: "seats", positions: [[37, 38, null, null, 39]] },
                { type: "seats", positions: [[null, null, null, null, 40]] },
                { type: "seats", positions: [[41, 42, null, null, 43]] },
                { type: "seats", positions: [[44, null, null, 45, 46]] },
                { type: "seats", positions: [[47, null, null, null, null]] },
                { type: "seats", positions: [[48, null, null, 49, 50]] },
                { type: "space", height: 80 },
                { type: "seats", positions: [[51, 52, null, null, 53]] },
                { type: "seats", positions: [[null, null, null, null, 54]] },
                { type: "seats", positions: [[55, 56, null, null, 57]] },
                { type: "seats", positions: [[58, null, null, 59, 60]] },
                { type: "seats", positions: [[61, null, null, null, null]] },
                { type: "seats", positions: [[62, null, null, null, 63]] }
            ]
        },
        {
            id: "C4",
            name: "Coche 4",
            layout: [
                { type: "seats", positions: [[64, null, null, null, 65]] },
                { type: "seats", positions: [[null, null, null, null, 66]] },
                { type: "seats", positions: [[67, 68, null, null, 69]] },
                { type: "seats", positions: [[70, null, null, 71, 72]] },
                { type: "seats", positions: [[73, null, null, null, null]] },
                { type: "seats", positions: [[74, null, null, 75, 76]] },
                { type: "space", height: 80 },
                { type: "seats", positions: [[77, 78, null, null, 79]] },
                { type: "seats", positions: [[null, null, null, null, 80]] },
                { type: "seats", positions: [[81, 82, null, null, 83]] },
                { type: "seats", positions: [[84, null, null, 85, 86]] },
                { type: "seats", positions: [[87, null, null, null, null]] },
                { type: "seats", positions: [[88, null, null, 89, 90]] },
                { type: "seats", positions: [[91, null, null, 92, 93]] },
                { type: "seats", positions: [[94, null, null, null, null]] },
                { type: "seats", positions: [[95, null, null, 96, 97]] },
                { type: "seats", positions: [[98, 99, null, null, 100]] },
                { type: "seats", positions: [[null, null, null, null, 101]] },
                { type: "seats", positions: [[102, 103, null, null, 104]] },
                { type: "space", height: 80 },
                { type: "seats", positions: [[105, null, null, 106, 107]] },
                { type: "seats", positions: [[108, null, null, null, null]] },
                { type: "seats", positions: [[109, null, null, 110, 111]] },
                { type: "seats", positions: [[112, 113, null, null, 114]] },
                { type: "seats", positions: [[null, null, null, null, 115]] },
                { type: "seats", positions: [[116, null, null, null, 117]] }
            ]
        },
        {
            id: "C3",
            name: "Coche 3",
            layout: [
                { type: "seats", positions: [[118, null, null, null, 119]] },
                { type: "seats", positions: [[120, null, null, null, 121]] },
                { type: "space", height: 50 },
                { type: "seats", positions: [[122, 123, null, 124, 125]] },
                { type: "seats", positions: [["PMR-126", null, null, null, "PMR-127"]] },
                { type: "pmr-bathroom", height: 160 },
                { type: "seats", positions: [[128, null, null, null, null]] },
                { type: "seats", positions: [[129, null, null, 130, 131]] },
                { type: "seats", positions: [[132, 133, null, null, 134]] },
                { type: "seats", positions: [[null, null, null, null, 135]] },
                { type: "seats", positions: [[136, 137, null, null, 138]] },
                { type: "space", height: 80 },
                { type: "seats", positions: [[139, 140, null, null, 141]] },
                { type: "seats", positions: [[null, null, null, null, 142]] },
                { type: "seats", positions: [[143, 144, null, null, 145]] },
                { type: "seats", positions: [[146, null, null, 147, 148]] },
                { type: "seats", positions: [[149, null, null, null, null]] },
                { type: "seats", positions: [[150, null, null, null, 151]] }
            ]
        },
        {
            id: "C1",
            name: "Coche 1",
            layout: [
                { type: "seats", positions: [[152, null, null, null, 153]] },
                { type: "seats", positions: [[null, null, null, null, 154]] },
                { type: "seats", positions: [[155, 156, null, null, 157]] },
                { type: "seats", positions: [[158, null, null, 159, 160]] },
                { type: "seats", positions: [[161, null, null, null, null]] },
                { type: "seats", positions: [[162, null, null, 163, 164]] },
                { type: "space", height: 80 },
                { type: "seats", positions: [[165, 166, null, null, 167]] },
                { type: "seats", positions: [[null, null, null, null, 168]] },
                { type: "seats", positions: [[169, 170, null, null, 171]] },
                { type: "seats", positions: [[172, null, null, 173, 174]] },
                { type: "seats", positions: [[175, null, null, null, null]] },
                { type: "seats", positions: [[176, null, null, 177, 178]] },
                { type: "seats", positions: [[179, null, null, 180, 181]] },
                { type: "seats", positions: [[182, null, null, null, null]] },
                { type: "seats", positions: [[183, null, null, 184, 185]] },
                { type: "seats", positions: [[186, 187, null, null, 188]] },
                { type: "seats", positions: [[null, null, null, null, 189]] },
                { type: "seats", positions: [[190, 191, null, null, 192]] },
                { type: "space", height: 80 },
                { type: "seats", positions: [[193, null, null, 194, 195]] },
                { type: "seats", positions: [[196, null, null, null, null]] },
                { type: "seats", positions: [[197, null, null, 198, 199]] },
                { type: "seats", positions: [[200, 201, null, null, 202]] },
                { type: "seats", positions: [[null, null, null, null, 203]] },
                { type: "seats", positions: [[204, 205, null, null, 206]] },
                { type: "seats", positions: [[207, 208, null, 209, 210]] },
                { type: "seats", positions: [[211, 212, null, 213, 214]] }
            ]
        }
    ]
},
    465: {
    name: "Tren 465",
    coaches: [
        {
            id: "C2",
            name: "Coche 2",
            layout: [
                { type: "seats", positions: [[1, 2, null, 3, 4]] },
                { type: "seats", positions: [[5, 6, null, 7, 8]] },
                { type: "seats", positions: [[9, null, null, 10, 11]] },
                { type: "seats", positions: [[12, null, null, null, null]] },
                { type: "seats", positions: [[13, null, null, 14, 15]] },
                { type: "seats", positions: [[16, 17, null, null, 18]] },
                { type: "seats", positions: [[null, null, null, null, 19]] },
                { type: "seats", positions: [[20, 21, null, null, 22]] },
                { type: "space", height: 80 },
                { type: "seats", positions: [[23, null, null, 24, 25]] },
                { type: "seats", positions: [[26, null, null, null, null]] },
                { type: "seats", positions: [[27, null, null, 28, 29]] },
                { type: "seats", positions: [[30, 31, null, null, 32]] },
                { type: "seats", positions: [[null, null, null, null, 33]] },
                { type: "seats", positions: [[34, 35, null, null, 36]] },
                { type: "seats", positions: [[37, 38, null, null, 39]] },
                { type: "seats", positions: [[null, null, null, null, 40]] },
                { type: "seats", positions: [[41, 42, null, null, 43]] },
                { type: "seats", positions: [[44, null, null, 45, 46]] },
                { type: "seats", positions: [[47, null, null, null, null]] },
                { type: "seats", positions: [[48, null, null, 49, 50]] },
                { type: "space", height: 80 },
                { type: "seats", positions: [[51, 52, null, null, 53]] },
                { type: "seats", positions: [[null, null, null, null, 54]] },
                { type: "seats", positions: [[55, 56, null, null, 57]] },
                { type: "seats", positions: [[58, null, null, 59, 60]] },
                { type: "seats", positions: [[61, null, null, null, null]] },
                { type: "seats", positions: [[62, null, null, null, 63]] }
            ]
        },
        {
            id: "C4",
            name: "Coche 4",
            layout: [
                { type: "seats", positions: [[64, null, null, null, 65]] },
                { type: "seats", positions: [[null, null, null, null, 66]] },
                { type: "seats", positions: [[67, 68, null, null, 69]] },
                { type: "seats", positions: [[70, null, null, 71, 72]] },
                { type: "seats", positions: [[73, null, null, null, null]] },
                { type: "seats", positions: [[74, null, null, 75, 76]] },
                { type: "space", height: 80 },
                { type: "seats", positions: [[77, 78, null, null, 79]] },
                { type: "seats", positions: [[null, null, null, null, 80]] },
                { type: "seats", positions: [[81, 82, null, null, 83]] },
                { type: "seats", positions: [[84, null, null, 85, 86]] },
                { type: "seats", positions: [[87, null, null, null, null]] },
                { type: "seats", positions: [[88, null, null, 89, 90]] },
                { type: "seats", positions: [[91, null, null, 92, 93]] },
                { type: "seats", positions: [[94, null, null, null, null]] },
                { type: "seats", positions: [[95, null, null, 96, 97]] },
                { type: "seats", positions: [[98, 99, null, null, 100]] },
                { type: "seats", positions: [[null, null, null, null, 101]] },
                { type: "seats", positions: [[102, 103, null, null, 104]] },
                { type: "space", height: 80 },
                { type: "seats", positions: [[105, null, null, 106, 107]] },
                { type: "seats", positions: [[108, null, null, null, null]] },
                { type: "seats", positions: [[109, null, null, 110, 111]] },
                { type: "seats", positions: [[112, 113, null, null, 114]] },
                { type: "seats", positions: [[null, null, null, null, 115]] },
                { type: "seats", positions: [[116, null, null, null, 117]] }
            ]
        },
        {
            id: "C3",
            name: "Coche 3",
            layout: [
                { type: "seats", positions: [[118, null, null, null, 119]] },
                { type: "seats", positions: [[120, null, null, null, 121]] },
                { type: "space", height: 50 },
                { type: "seats", positions: [[122, 123, null, 124, 125]] },
                { type: "seats", positions: [["PMR-126", null, null, null, "PMR-127"]] },
                { type: "pmr-bathroom", height: 160 },
                { type: "seats", positions: [[128, null, null, null, null]] },
                { type: "seats", positions: [[129, null, null, 130, 131]] },
                { type: "seats", positions: [[132, 133, null, null, 134]] },
                { type: "seats", positions: [[null, null, null, null, 135]] },
                { type: "seats", positions: [[136, 137, null, null, 138]] },
                { type: "space", height: 80 },
                { type: "seats", positions: [[139, 140, null, null, 141]] },
                { type: "seats", positions: [[null, null, null, null, 142]] },
                { type: "seats", positions: [[143, 144, null, null, 145]] },
                { type: "seats", positions: [[146, null, null, 147, 148]] },
                { type: "seats", positions: [[149, null, null, null, null]] },
                { type: "seats", positions: [[150, null, null, null, 151]] }
            ]
        },
{
            id: "C5",
            name: "Coche 5",
            layout: [
    { type: "seats", positions: [[152, null, null, null, 153]] },
    { type: "seats", positions: [[null, null, null, null, 154]] },
    { type: "seats", positions: [[155, 156, null, null, 157]] },
    { type: "seats", positions: [[158, null, null, 159, 160]] },
    { type: "seats", positions: [[161, null, null, null, null]] },
    { type: "seats", positions: [[162, null, null, 163, 164]] },
    { type: "space", height: 80 },
    { type: "seats", positions: [[165, 166, null, null, 167]] },
    { type: "seats", positions: [[null, null, null, null, 168]] },
    { type: "seats", positions: [[169, 170, null, null, 171]] },
    { type: "seats", positions: [[172, null, null, 173, 174]] },
    { type: "seats", positions: [[175, null, null, null, null]] },
    { type: "seats", positions: [[176, null, null, 177, 178]] },
    { type: "seats", positions: [[179, null, null, 180, 181]] },
    { type: "seats", positions: [[182, null, null, null, null]] },
    { type: "seats", positions: [[183, null, null, 184, 185]] },
    { type: "seats", positions: [[186, 187, null, null, 188]] },
    { type: "seats", positions: [[null, null, null, null, 189]] },
    { type: "seats", positions: [[190, 191, null, null, 192]] },
    { type: "space", height: 80 },
    { type: "seats", positions: [[193, null, null, 194, 195]] },
    { type: "seats", positions: [[196, null, null, null, null]] },
    { type: "seats", positions: [[197, null, null, 198, 199]] },
    { type: "seats", positions: [[200, 201, null, null, 202]] },
    { type: "seats", positions: [[null, null, null, null, 203]] },
    { type: "seats", positions: [[204, null, null, null, 205]] }
]

        },
        {
            id: "C1",
            name: "Coche 1",
            layout: [
    { type: "seats", positions: [[206, null, null, null, 207]] },
    { type: "seats", positions: [[null, null, null, null, 208]] },
    { type: "seats", positions: [[209, 210, null, null, 211]] },
    { type: "seats", positions: [[212, null, null, 213, 214]] },
    { type: "seats", positions: [[215, null, null, null, null]] },
    { type: "seats", positions: [[216, null, null, 217, 218]] },
    { type: "space", height: 80 },
    { type: "seats", positions: [[219, 220, null, null, 221]] },
    { type: "seats", positions: [[null, null, null, null, 222]] },
    { type: "seats", positions: [[223, 224, null, null, 225]] },
    { type: "seats", positions: [[226, null, null, 227, 228]] },
    { type: "seats", positions: [[229, null, null, null, null]] },
    { type: "seats", positions: [[230, null, null, 231, 232]] },
    { type: "seats", positions: [[233, null, null, 234, 235]] },
    { type: "seats", positions: [[236, null, null, null, null]] },
    { type: "seats", positions: [[237, null, null, 238, 239]] },
    { type: "seats", positions: [[240, 241, null, null, 242]] },
    { type: "seats", positions: [[null, null, null, null, 243]] },
    { type: "seats", positions: [[244, 245, null, null, 246]] },
    { type: "space", height: 80 },
    { type: "seats", positions: [[247, null, null, 248, 249]] },
    { type: "seats", positions: [[250, null, null, null, null]] },
    { type: "seats", positions: [[251, null, null, 252, 253]] },
    { type: "seats", positions: [[254, 255, null, null, 256]] },
    { type: "seats", positions: [[null, null, null, null, 257]] },
    { type: "seats", positions: [[258, 259, null, null, 260]] },
    { type: "seats", positions: [[261, 262, null, 263, 264]] },
    { type: "seats", positions: [[265, 266, null, 267, 268]] }
]
        }
    ]
},
449: {
    name: "Tren 449",
    coaches: [
        {
            id: "C2",
            name: "Coche 2",
            layout: [
                { type: "seats", positions: [[3, 4, null, 2, 1]] },
                { type: "seats", positions: [[7, 8, null, 6, 5]] },
                { type: "seats", positions: [[11, 12, null, 10, 9]] },
                { type: "seats", positions: [["MESA", "MESA", null, "MESA", "MESA"]] },
                { type: "seats", positions: [[15, 16, null, 14, 13]] },
                { type: "seats", positions: [[19, 20, null, 18, 17]] },
                { type: "seats", positions: [[23, 24, null, 22, 21]] },
                { type: "seats", positions: [[27, 28, null, 26, 25]] },
                { type: "seats", positions: [[29, 30, null, "EQ", "EQ"]] },
                { type: "seats", positions: [[null, null, null, "WC", "WC"]] },
                { type: "space", height: 120 },
                { type: "seats", positions: [["EQ", "EQ", null, 32, 31]] },
                { type: "seats", positions: [[35, 36, null, 34, 33]] },
                { type: "seats", positions: [[39, 40, null, 38, 37]] },
                { type: "seats", positions: [[43, 44, null, 42, 41]] },
                { type: "seats", positions: [[47, 48, null, 46, 45]] },
                { type: "seats", positions: [["MESA", "MESA", null, "MESA", "MESA"]] },
                { type: "seats", positions: [[51, 52, null, 50, 49]] },
                { type: "seats", positions: [[55, 56, null, 54, 53]] },
                { type: "seats", positions: [[59, 60, null, 58, 57]] }
            ]
        },
        {
            id: "C4",
            name: "Coche 4",
            layout: [
                { type: "seats", positions: [[63, 64, null, 62, 61]] },
                { type: "seats", positions: [[67, 68, null, 66, 65]] },
                { type: "seats", positions: [[71, 72, null, 70, 69]] },
                { type: "seats", positions: [["MESA", "MESA", null, "MESA", "MESA"]] },
                { type: "seats", positions: [[75, 76, null, 74, 73]] },
                { type: "seats", positions: [[79, 80, null, 78, 77]] },
                { type: "seats", positions: [[83, 84, null, 82, 81]] },
                { type: "seats", positions: [[87, 88, null, 86, 85]] },
                { type: "seats", positions: [["EQ", "EQ", null, "EQ", "EQ"]] },
                { type: "space", height: 80 },
                { type: "seats", positions: [["EQ", "EQ", null, "EQ", "EQ"]] },
                { type: "seats", positions: [[91, 92, null, 90, 89]] },
                { type: "seats", positions: [[95, 96, null, 94, 93]] },
                { type: "seats", positions: [[99, 100, null, 98, 97]] },
                { type: "seats", positions: [[103, 104, null, 102, 101]] },
                { type: "seats", positions: [["MESA", "MESA", null, "MESA", "MESA"]] },
                { type: "seats", positions: [[107, 108, null, 106, 105]] },
                { type: "seats", positions: [[111, 112, null, 110, 109]] },
                { type: "seats", positions: [[115, 116, null, 114, 113]] }
            ]
        },
{
    id: "C3",
    name: "Coche 3",
    layout: [
        { type: "seats", positions: [[119, 120, null, 118, 117]] },
        { type: "seats", positions: [[123, 124, null, 122, 121]] },
        { type: "seats", positions: [["MESA", "MESA", null, "MESA", "MESA"]] },
        { type: "seats", positions: [[127, 128, null, 126, 125]] },
        { type: "pmr-bathroom", height: 160, label: "ESPACIO OCIO, BAÑO PMR, BICIS, VENDING..." },
{ type: "space", height: 60 },
        { type: "seats", positions: [["EQ", null, null, null, "PMR-0"]] },
{ type: "space", height: 40 },
        { type: "seats", positions: [["S3", "S4", null, "S2", "S1"]] },
        { type: "seats", positions: [[133, 134, null, 132, 131]] },
        { type: "seats", positions: [["MESA", "MESA", null, "MESA", "MESA"]] },
        { type: "seats", positions: [[137, 138, null, 136, 135]] },
        { type: "seats", positions: [[141, 142, null, 140, 139]] }
    ]
},
{
    id: "C5",
    name: "Coche 5",
    layout: [
        { type: "seats", positions: [[145, 146, null, 144, 143]] },
        { type: "seats", positions: [[149, 150, null, 148, 147]] },
        { type: "seats", positions: [[153, 154, null, 152, 151]] },
        { type: "seats", positions: [["MESA", "MESA", null, "MESA", "MESA"]] },
        { type: "seats", positions: [[157, 158, null, 156, 155]] },
        { type: "seats", positions: [[161, 162, null, 160, 159]] },
        { type: "seats", positions: [[165, 166, null, 164, 163]] },
        { type: "seats", positions: [[169, 170, null, 168, 167]] },
        { type: "seats", positions: [["EQ", "EQ", null, "EQ", "EQ"]] },
        { type: "space", height: 80 },
        { type: "seats", positions: [["EQ", "EQ", null, "EQ", "EQ"]] },
        { type: "seats", positions: [[173, 174, null, 172, 171]] },
        { type: "seats", positions: [[177, 178, null, 176, 175]] },
        { type: "seats", positions: [[181, 182, null, 180, 179]] },
        { type: "seats", positions: [[185, 186, null, 184, 183]] },
        { type: "seats", positions: [["MESA", "MESA", null, "MESA", "MESA"]] },
        { type: "seats", positions: [[189, 190, null, 188, 187]] },
        { type: "seats", positions: [[193, 194, null, 192, 191]] },
        { type: "seats", positions: [[197, 198, null, 196, 195]] }
    ]
},
{
    id: "C1",
    name: "Coche 1",
    layout: [
        { type: "seats", positions: [[201, 202, null, 200, 199]] },
        { type: "seats", positions: [[205, 206, null, 204, 203]] },
        { type: "seats", positions: [[209, 210, null, 208, 207]] },
        { type: "seats", positions: [["MESA", "MESA", null, "MESA", "MESA"]] },
        { type: "seats", positions: [[213, 214, null, 212, 211]] },
        { type: "seats", positions: [[217, 218, null, 216, 215]] },
        { type: "seats", positions: [[221, 222, null, 220, 219]] },
        { type: "seats", positions: [[225, 226, null, 224, 223]] },
        { type: "seats", positions: [[227, 228, null, "EQ", "EQ"]] },
        { type: "space", height: 160 },
        { type: "seats", positions: [["EQ", "EQ", null, 230, 229]] },
        { type: "seats", positions: [[233, 234, null, 232, 231]] },
        { type: "seats", positions: [[237, 238, null, 236, 235]] },
        { type: "seats", positions: [[241, 242, null, 240, 239]] },
        { type: "seats", positions: [[245, 246, null, 244, 243]] },
        { type: "seats", positions: [["MESA", "MESA", null, "MESA", "MESA"]] },
        { type: "seats", positions: [[249, 250, null, 248, 247]] },
        { type: "seats", positions: [[253, 254, null, 252, 251]] },
        { type: "seats", positions: [[257, 258, null, 256, 255]] }
    ]
}
    ]
},
    470: {
        name: "Tren 470",
        coaches: [{
                id: "C1",
                name: "Coche 1",
                layout: [{
                    type: "space",
                    height: 60
                },
                    {
                        type: "seats",
                        positions: [
                            [null, null, null, "S1", "S2"]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            ["S3", "S4", null, "S6", "S5"]
                        ]
                    },
                    {
                        type: "space",
                        height: 80
                    },
                    {
                        type: "seats",
                        positions: [
                            [3, 4, null, 2, 1]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [7, 8, null, 6, 5]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [11, 12, null, 10, 9]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [15, 16, null, 14, 13]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [19, 20, null, 18, 17]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [23, 24, null, 22, 21]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [27, 28, null, 26, 25]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            ["EQ", "EQ", null, 30, 29]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            ["EQ", "EQ", null, 32, 31]
                        ]
                    },
                    {
                        type: "space",
                        height: 80
                    },
                    {
                        type: "seats",
                        positions: [
                            [35, 36, null, 34, 33]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [39, 40, null, 38, 37]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [43, 44, null, 42, 41]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [47, 48, null, 46, 45]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [51, 52, null, 50, 49]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [55, 56, null, 54, 53]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [59, 60, null, 58, 57]
                        ]
                    },
                ],
            },
            {
                id: "C2",
                name: "Coche 2",
                layout: [{
                        type: "seats",
                        positions: [
                            [61, 62, null, "WC", "WC"]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [63, 64, null, "WC", "WC"]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [67, 68, null, 66, 65]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [71, 72, null, 70, 69]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [75, 76, null, 74, 73]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [79, 80, null, 78, 77]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [83, 84, null, 82, 81]
                        ]
                    },
                    {
                        type: "space",
                        height: 80
                    },
                    {
                        type: "seats",
                        positions: [
                            [85, 86, null, "MIN", "MIN"]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [87, 88, null, "EQ", "EQ"]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [91, 92, null, 90, 89]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [95, 96, null, 94, 93]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [99, 100, null, 98, 97]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [103, 104, null, 102, 101]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [107, 108, null, 106, 105]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [111, 112, null, 110, 109]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [115, 116, null, 114, 113]
                        ]
                    },
                    {
                        type: "space",
                        height: 80
                    },
                    {
                        type: "seats",
                        positions: [
                            [119, 120, null, 118, 117]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [123, 124, null, 122, 121]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [127, 128, null, 126, 125]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [131, 132, null, 130, 129]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [135, 136, null, 134, 133]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [139, 140, null, 138, 137]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [143, 144, null, 142, 141]
                        ]
                    },
                ],
            },
            {
                id: "C3",
                name: "Coche 3",
                layout: [{
                        type: "seats",
                        positions: [
                            [143, 144, null, 142, 141]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [147, 148, null, 146, 145]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [151, 152, null, 150, 149]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [155, 156, null, 154, 153]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [159, 160, null, 158, 157]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [163, 164, null, 162, 161]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [167, 168, null, 166, 165]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [171, 172, null, 170, 169]
                        ]
                    },
                    {
                        type: "space",
                        height: 80
                    },
                    {
                        type: "seats",
                        positions: [
                            [173, 174, null, "EQ", "EQ"]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [175, 176, null, "EQ", "EQ"]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [179, 180, null, 178, 177]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [183, 184, null, 182, 181]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [187, 188, null, 186, 185]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [191, 192, null, 190, 189]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [195, 196, null, 194, 193]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [199, 200, null, 198, 197]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [203, 204, null, 202, 201]
                        ]
                    },
                    {
                        type: "space",
                        height: 160
                    },
                    {
                        type: "seats",
                        positions: [
                            [207, 208, null, 206, 205]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [211, 212, null, 210, 209]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [215, 216, null, 214, 213]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [219, 220, null, 218, 217]
                        ]
                    },
                    {
                        type: "seats",
                        positions: [
                            [223, 224, null, 222, 221]
                        ]
                    },
                ],
            },
        ],
    },
};

// Paradas
const stops = [{
        full: "Zaragoza Miraflores",
        abbr: "ZMI"
    },
    {
        full: "Zaragoza Goya",
        abbr: "ZGO"
    },
    {
        full: "Zaragoza Portillo",
        abbr: "ZPO"
    },
    {
        full: "Zaragoza Delicias",
        abbr: "ZDE"
    },
    {
        full: "Utebo",
        abbr: "UTE"
    },
    {
        full: "Casetas",
        abbr: "CAS"
    },
    {
        full: "Alagón",
        abbr: "ALA"
    },
    {
        full: "Cabañas",
        abbr: "CAB"
    },
    {
        full: "Pedrola",
        abbr: "PED"
    },
    {
        full: "Luceni",
        abbr: "LUC"
    },
    {
        full: "Gallur",
        abbr: "GAL"
    },
    {
        full: "Cortes",
        abbr: "COR"
    },
    {
        full: "Ribaforada",
        abbr: "RIB"
    },
    {
        full: "Tudela",
        abbr: "TUD"
    },
    {
        full: "Castejón",
        abbr: "CTJ"
    },
    {
        full: "Villafranca",
        abbr: "VIL"
    },
    {
        full: "Marcilla",
        abbr: "MAR"
    },
    {
        full: "Olite Erriberri",
        abbr: "OLI"
    },
    {
        full: "Tafalla",
        abbr: "TAF"
    },
    {
        full: "Pamplona Iruña",
        abbr: "PAM"
    },
    {
        full: "Uharte Arakil",
        abbr: "UHA"
    },
    {
        full: "Etxarri Aranatz",
        abbr: "ETX"
    },
    {
        full: "Altsasu Pueblo",
        abbr: "ALT"
    },
    {
        full: "Araia",
        abbr: "ARA"
    },
    {
        full: "Agurain Salvatierra",
        abbr: "AGU"
    },
    {
        full: "Alegria Dulantzi",
        abbr: "ALE"
    },
    {
        full: "Vitoria Gasteiz",
        abbr: "VIT"
    },
    {
        full: "Nanclares Langraiz",
        abbr: "NAN"
    },
    {
        full: "La Puebla Arganzón",
        abbr: "PUE"
    },
    {
        full: "Manzanos",
        abbr: "MAN"
    },
    {
        full: "Miranda",
        abbr: "MIR"
    },
    {
        full: "Alfaro",
        abbr: "ALF"
    },
    {
        full: "Rincón de Soto",
        abbr: "RIN"
    },
    {
        full: "Calahorra",
        abbr: "CAL"
    },
    {
        full: "Féculas Navarra",
        abbr: "FEC"
    },
    {
        full: "Alcanadre",
        abbr: "ALC"
    },
    {
        full: "Logroño",
        abbr: "LOG"
    },
];

// Configuración de números de tren y sus destinos finales
const trainNumbers = {
    '18048': ['Zaragoza Miraflores', 'Zaragoza Goya', 'Zaragoza Portillo', 'Zaragoza Delicias'],
    '18023': ['Pamplona Iruña'],
    '18029': ['Zaragoza Miraflores', 'Zaragoza Goya', 'Zaragoza Portillo', 'Zaragoza Delicias'],
    '16070': ['Zaragoza Miraflores', 'Zaragoza Goya', 'Zaragoza Portillo', 'Zaragoza Delicias'],
    '18039': ['Pamplona Iruña'],
    '18077': ['Pamplona Iruña'],
    '18021': ['Vitoria Gasteiz'],
    '16011': ['Zaragoza Miraflores', 'Zaragoza Goya', 'Zaragoza Portillo', 'Zaragoza Delicias'],
    '18071': ['Vitoria Gasteiz'],
    '16019': ['Pamplona Iruña'],
    '18079': ['Castejón'],
    '18022': ['Zaragoza Miraflores', 'Zaragoza Goya', 'Zaragoza Portillo', 'Zaragoza Delicias'],
    '18068': ['Zaragoza Miraflores', 'Zaragoza Goya', 'Zaragoza Portillo', 'Zaragoza Delicias'],
    '18074': ['Zaragoza Miraflores', 'Zaragoza Goya', 'Zaragoza Portillo', 'Zaragoza Delicias'],
    '18046': ['Zaragoza Miraflores', 'Zaragoza Goya', 'Zaragoza Portillo', 'Zaragoza Delicias'],
    '18073': ['Castejón'],
    '16020': ['Zaragoza Miraflores', 'Zaragoza Goya', 'Zaragoza Portillo', 'Zaragoza Delicias']
};

// Rutas de cada número de tren (orden de paradas)
const trainRoutes = {
    '18048': ['Castejón', 'Tudela', 'Ribaforada', 'Cortes', 'Gallur', 'Luceni', 'Pedrola', 'Cabañas', 'Alagón', 'Casetas', 'Utebo', 'Zaragoza Delicias', 'Zaragoza Portillo', 'Zaragoza Goya', 'Zaragoza Miraflores'],
    '18023': ['Zaragoza Miraflores', 'Zaragoza Goya', 'Zaragoza Portillo', 'Zaragoza Delicias', 'Utebo', 'Casetas', 'Alagón', 'Cabañas', 'Pedrola', 'Luceni', 'Gallur', 'Cortes', 'Ribaforada', 'Tudela', 'Castejón', 'Villafranca', 'Marcilla', 'Olite Erriberri', 'Tafalla', 'Pamplona Iruña'],
    '18029': ['Miranda', 'Manzanos', 'La Puebla Arganzón', 'Nanclares Langraiz', 'Vitoria Gasteiz', 'Alegria Dulantzi', 'Agurain Salvatierra', 'Araia', 'Altsasu Pueblo', 'Etxarri Aranatz', 'Uharte Arakil', 'Pamplona Iruña', 'Tafalla', 'Olite Erriberri', 'Marcilla', 'Villafranca', 'Castejón', 'Tudela', 'Ribaforada', 'Cortes', 'Gallur', 'Luceni', 'Pedrola', 'Cabañas', 'Alagón', 'Casetas', 'Utebo', 'Zaragoza Delicias', 'Zaragoza Portillo', 'Zaragoza Goya', 'Zaragoza Miraflores'],
    '16070': ['Logroño', 'Alcanadre', 'Calahorra', 'Rincón de Soto', 'Alfaro', 'Castejón', 'Tudela', 'Ribaforada', 'Cortes', 'Gallur', 'Luceni', 'Pedrola', 'Cabañas', 'Alagón', 'Casetas', 'Utebo', 'Zaragoza Delicias', 'Zaragoza Portillo', 'Zaragoza Goya', 'Zaragoza Miraflores'],
    '18039': ['Zaragoza Miraflores', 'Zaragoza Goya', 'Zaragoza Portillo', 'Zaragoza Delicias', 'Utebo', 'Casetas', 'Alagón', 'Cabañas', 'Pedrola', 'Luceni', 'Gallur', 'Cortes', 'Ribaforada', 'Tudela', 'Castejón', 'Villafranca', 'Marcilla', 'Olite Erriberri', 'Tafalla', 'Pamplona Iruña'],
    '18077': ['Zaragoza Miraflores', 'Zaragoza Goya', 'Zaragoza Portillo', 'Zaragoza Delicias', 'Utebo', 'Casetas', 'Alagón', 'Cabañas', 'Pedrola', 'Luceni', 'Gallur', 'Cortes', 'Ribaforada', 'Tudela', 'Castejón', 'Villafranca', 'Marcilla', 'Olite Erriberri', 'Tafalla', 'Pamplona Iruña'],
    '18021': ['Zaragoza Miraflores', 'Zaragoza Goya', 'Zaragoza Portillo', 'Zaragoza Delicias', 'Utebo', 'Casetas', 'Alagón', 'Cabañas', 'Pedrola', 'Luceni', 'Gallur', 'Cortes', 'Ribaforada', 'Tudela', 'Castejón', 'Villafranca', 'Marcilla', 'Olite Erriberri', 'Tafalla', 'Pamplona Iruña', 'Uharte Arakil', 'Etxarri Aranatz', 'Altsasu Pueblo', 'Araia', 'Agurain Salvatierra', 'Alegria Dulantzi', 'Vitoria Gasteiz', 'Nanclares Langraiz', 'La Puebla Arganzón', 'Manzanos', 'Miranda'],
    '16011': ['Vitoria Gasteiz', 'Alegria Dulantzi', 'Agurain Salvatierra', 'Araia', 'Altsasu Pueblo', 'Etxarri Aranatz', 'Uharte Arakil', 'Pamplona Iruña', 'Tafalla', 'Olite Erriberri', 'Marcilla', 'Villafranca', 'Castejón'],
    '18071': ['Zaragoza Miraflores', 'Zaragoza Goya', 'Zaragoza Portillo', 'Zaragoza Delicias', 'Utebo', 'Casetas', 'Alagón', 'Cabañas', 'Pedrola', 'Luceni', 'Gallur', 'Cortes', 'Ribaforada', 'Tudela', 'Castejón', 'Villafranca', 'Marcilla', 'Olite Erriberri', 'Tafalla', 'Pamplona Iruña', 'Uharte Arakil', 'Etxarri Aranatz', 'Altsasu Pueblo', 'Araia', 'Agurain Salvatierra', 'Alegria Dulantzi', 'Vitoria Gasteiz', 'Nanclares Langraiz', 'La Puebla Arganzón', 'Manzanos', 'Miranda'],
    '16019': ['Miranda', 'Vitoria Gasteiz', 'Alegria Dulantzi', 'Agurain Salvatierra', 'Araia', 'Altsasu Pueblo', 'Etxarri Aranatz', 'Uharte Arakil', 'Pamplona Iruña'],
    '18079': ['Zaragoza Miraflores', 'Zaragoza Goya', 'Zaragoza Portillo', 'Zaragoza Delicias', 'Utebo', 'Casetas', 'Alagón', 'Cabañas', 'Pedrola', 'Luceni', 'Gallur', 'Cortes', 'Ribaforada', 'Tudela', 'Castejón', 'Alfaro', 'Rincón de Soto', 'Calahorra', 'Alcanadre', 'Logroño'],
    '18022': ['Vitoria Gasteiz', 'Alegria Dulantzi', 'Agurain Salvatierra', 'Araia', 'Altsasu Pueblo', 'Etxarri Aranatz', 'Uharte Arakil', 'Pamplona Iruña', 'Tafalla', 'Olite Erriberri', 'Marcilla', 'Villafranca', 'Castejón'],
    '18068': ['Castejón', 'Tudela', 'Ribaforada', 'Cortes', 'Gallur', 'Luceni', 'Pedrola', 'Cabañas', 'Alagón', 'Casetas', 'Utebo', 'Zaragoza Delicias', 'Zaragoza Portillo', 'Zaragoza Goya', 'Zaragoza Miraflores'],
    '18074': ['Castejón', 'Tudela', 'Ribaforada', 'Cortes', 'Gallur', 'Luceni', 'Pedrola', 'Cabañas', 'Alagón', 'Casetas', 'Utebo', 'Zaragoza Delicias', 'Zaragoza Portillo', 'Zaragoza Goya', 'Zaragoza Miraflores'],
    '18046': ['Pamplona Iruña', 'Tafalla', 'Olite Erriberri', 'Marcilla', 'Villafranca', 'Castejón', 'Tudela', 'Ribaforada', 'Cortes', 'Gallur', 'Luceni', 'Pedrola', 'Cabañas', 'Alagón', 'Casetas', 'Utebo', 'Zaragoza Delicias', 'Zaragoza Portillo', 'Zaragoza Goya', 'Zaragoza Miraflores'],
    '18073': ['Zaragoza Miraflores', 'Zaragoza Goya', 'Zaragoza Portillo', 'Zaragoza Delicias', 'Utebo', 'Casetas', 'Alagón', 'Cabañas', 'Pedrola', 'Luceni', 'Gallur', 'Cortes', 'Ribaforada', 'Tudela', 'Castejón', 'Alfaro', 'Rincón de Soto', 'Calahorra', 'Alcanadre', 'Logroño'],
    '16020': ['Pamplona Iruña', 'Tafalla', 'Olite Erriberri', 'Marcilla', 'Villafranca', 'Castejón', 'Tudela', 'Ribaforada', 'Cortes', 'Gallur', 'Luceni', 'Pedrola', 'Cabañas', 'Alagón', 'Casetas', 'Utebo', 'Zaragoza Delicias', 'Zaragoza Portillo', 'Zaragoza Goya', 'Zaragoza Miraflores']
};

// Función para determinar si un coche es el primero o último visualmente
function getCoachPosition(coachId) {
    // Verificar si ya está en cache
    if (state.coachPositions && state.coachPositions[coachId]) {
        return state.coachPositions[coachId];
    }

    const currentTrain = trainModels[state.selectedTrain];
    const coaches = currentTrain.coaches;
    const index = coaches.findIndex(c => c.id === coachId);

    const result = {
        isFirst: index === 0,
        isLast: index === coaches.length - 1
    };

    // Guardar en cache
    if (!state.coachPositions) {
        state.coachPositions = {};
    }
    state.coachPositions[coachId] = result;

    return result;
}

// Función para obtener la etiqueta de cabina según dirección
function getCabinaLabel(coachId) {
    const direction = state.trainDirection[coachId] || "up";
    const position = getCoachPosition(coachId);

    // Con flecha hacia arriba: CABEZA al inicio, COLA al final
    // Con flecha hacia abajo: COLA al inicio, CABEZA al final
    if (direction === "up") {
        if (position.isFirst) return "CABEZA";
        if (position.isLast) return "COLA";
    } else {
        if (position.isFirst) return "COLA";
        if (position.isLast) return "CABEZA";
    }

    return "CABINA"; // fallback (no debería usarse)
}

// Función para obtener el símbolo de flecha del pasillo
function getAisleArrow(coachId) {
    const direction = state.trainDirection[coachId] || "up";
    const isRotated = state.rotateSeats;

    // Si está rotado, invertimos la flecha visualmente
    if (isRotated) {
        return direction === "up" ? "↓" : "↑";
    }

    return direction === "up" ? "↑" : "↓";
}

// Obtener paradas disponibles para filtrar
function getAvailableStopsForFilter() {
    if (!state.trainNumber || !trainRoutes[state.trainNumber]) return [];

    const route = trainRoutes[state.trainNumber];

    if (!state.currentStop) {
        return route; // Todas disponibles si no hay parada actual
    }

    const currentIndex = route.indexOf(state.currentStop);
    if (currentIndex === -1) return route;

    // Solo paradas desde la actual hasta el final
    return route.slice(currentIndex);
}

// Obtener asientos que se bajan en una parada específica
function getSeatsForStop(stopName) {
    const seats = [];
    Object.keys(state.seatData).forEach(key => {
        const seatInfo = state.seatData[key];
        if (seatInfo && seatInfo.stop && seatInfo.stop.full === stopName) {
            const [coachId, seatNum] = key.split('-');
            seats.push({ coach: coachId, seat: seatNum, info: seatInfo });
        }
    });
    return seats;
}

// Obtener asientos en un tramo
// Obtener asientos en un tramo
function getSeatsInRoute(fromStop, toStop) {
    if (!state.trainNumber || !trainRoutes[state.trainNumber]) return [];

    const route = trainRoutes[state.trainNumber];
    const fromIndex = route.indexOf(fromStop);
    const toIndex = route.indexOf(toStop);

    // validación: ambos en ruta y from antes que to
    if (fromIndex === -1 || toIndex === -1 || fromIndex >= toIndex) return [];

    const seats = [];

    Object.keys(state.seatData).forEach(key => {
        const seatInfo = state.seatData[key];
        if (seatInfo && seatInfo.stop) {
            const stopIndex = route.indexOf(seatInfo.stop.full);
            // Incluir asientos cuya parada está dentro del tramo (exclusivo en origen, inclusivo en destino)
            if (stopIndex >= fromIndex && stopIndex <= toIndex) {
                const [coachId, seatNum] = key.split('-');
                seats.push({ coach: coachId, seat: seatNum, info: seatInfo });
            }
        }
    });

    return seats;
}

// Obtener información de un asiento
function getSeatInfo(seatNumber) {
    // Buscar en todos los coches
    const keys = Object.keys(state.seatData);
    const foundKey = keys.find(key => {
        const [, num] = key.split('-');
        return num === String(seatNumber);
    });

    if (!foundKey) return null;

    const [coachId, seatNum] = foundKey.split('-');
    return {
        coach: coachId,
        seat: seatNum,
        data: state.seatData[foundKey]
    };
}

// Aplicar filtro visual
function applyFilterHighlight(seatKeys) {
    filterState.active = true;
    filterState.data = seatKeys;
    render();
}

// Limpiar filtro visual
function clearFilterHighlight() {
    filterState.active = false;
    filterState.type = null;
    filterState.data = null;
    render();
}

function openStopFilter() {
    toggleFiltersMenu();

    const availableStops = getAvailableStopsForFilter();
    if (availableStops.length === 0) {
        alert('No hay paradas disponibles para filtrar');
        return;
    }

    // Crear modal interactivo
    const modal = `
        <div class="modal-overlay" onclick="closeFilterInputModal(event)">
            <div class="modal about-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <div class="modal-header-top">
                        <h3 class="modal-title">Filtrar por parada de bajada</h3>
                        <button class="close-btn" onclick="closeFilterInputModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="filter-input-content">
                    <label class="filter-input-label">Introduce el nombre de la parada:</label>
                    <div style="position: relative;">
                        <input 
                            type="text" 
                            id="stop-filter-input" 
                            class="filter-text-input"
                            placeholder="Escribe para buscar..."
                            oninput="updateStopFilterSuggestions(this.value)"
                            autocomplete="off"
                        />
                        <div id="stop-suggestions" class="filter-suggestions hidden"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="clear-btn" onclick="closeFilterInputModal()">Cancelar</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modal);
    document.getElementById('stop-filter-input').focus();
    lockBodyScroll();
}

function updateStopFilterSuggestions(query) {
    const availableStops = getAvailableStopsForFilter();
    const suggestions = availableStops.filter(stop =>
        stop.toLowerCase().includes(query.toLowerCase())
    );

    const container = document.getElementById('stop-suggestions');

    if (query && suggestions.length > 0) {
        container.innerHTML = suggestions.slice(0, 5).map(stop => `
            <button class="suggestion-item" onclick="selectStopForFilter('${stop}')">
                ${stop}
            </button>
        `).join('');
        container.classList.remove('hidden');
    } else {
        container.classList.add('hidden');
    }
}

function selectStopForFilter(stopName) {
    closeFilterInputModal();

    const seats = getSeatsForStop(stopName);

    if (seats.length === 0) {
        alert(`No hay asientos con destino a ${stopName}`);
        return;
    }

    // Preguntar si quiere resaltar con modal personalizado
    showConfirmModal(
        `Se encontraron ${seats.length} asiento(s) con destino a ${stopName}\n\n` +
        `¿Deseas resaltarlos visualmente en la plantilla?`,
        () => {
            // Si acepta
            const seatKeys = seats.map(s => getSeatKey(s.coach, s.seat));
            filterState.type = 'stop';
            applyFilterHighlight(seatKeys);
            showStopFilterResults(stopName, seats);
        },
        () => {
            // Si cancela, solo mostrar resultados sin resaltar
            showStopFilterResults(stopName, seats);
        }
    );
}

function openRouteFilter() {
    toggleFiltersMenu();

    const availableStops = getAvailableStopsForFilter();
    if (availableStops.length < 2) {
        alert('No hay suficientes paradas disponibles');
        return;
    }

    // Crear modal para parada inicial
    const modal = `
        <div class="modal-overlay" onclick="closeFilterInputModal(event)">
            <div class="modal about-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <div class="modal-header-top">
                        <h3 class="modal-title">Filtrar por tramo recorrido</h3>
                        <button class="close-btn" onclick="closeFilterInputModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="filter-input-content">
                    <label class="filter-input-label">Introduce la parada inicial:</label>
                    <div style="position: relative;">
                        <input 
                            type="text" 
                            id="route-from-input" 
                            class="filter-text-input"
                            placeholder="Escribe para buscar..."
                            oninput="updateRouteFromSuggestions(this.value)"
                            autocomplete="off"
                        />
                        <div id="route-from-suggestions" class="filter-suggestions hidden"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="clear-btn" onclick="closeFilterInputModal()">Cancelar</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modal);
    document.getElementById('route-from-input').focus();
    lockBodyScroll();
}

function updateRouteFromSuggestions(query) {
    const availableStops = getAvailableStopsForFilter();
    const suggestions = availableStops.filter(stop =>
        stop.toLowerCase().includes(query.toLowerCase())
    );

    const container = document.getElementById('route-from-suggestions');

    if (query && suggestions.length > 0) {
        container.innerHTML = suggestions.slice(0, 5).map(stop => `
            <button class="suggestion-item" onclick="selectRouteFromStop('${stop}')">
                ${stop}
            </button>
        `).join('');
        container.classList.remove('hidden');
    } else {
        container.classList.add('hidden');
    }
}

function selectRouteFromStop(fromStop) {
    closeFilterInputModal();

    // Ahora pedir parada final
    const modal = `
        <div class="modal-overlay" onclick="closeFilterInputModal(event)">
            <div class="modal about-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <div class="modal-header-top">
                        <h3 class="modal-title">Filtrar por tramo recorrido</h3>
                        <button class="close-btn" onclick="closeFilterInputModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="filter-input-content">
                    <p style="margin-bottom: 1rem; color: #4f46e5; font-weight: 500;">Desde: ${fromStop}</p>
                    <label class="filter-input-label">Introduce la parada final:</label>
                    <div style="position: relative;">
                        <input 
                            type="text" 
                            id="route-to-input" 
                            class="filter-text-input"
                            placeholder="Escribe para buscar..."
                            oninput="updateRouteToSuggestions(this.value, '${fromStop}')"
                            autocomplete="off"
                        />
                        <div id="route-to-suggestions" class="filter-suggestions hidden"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="clear-btn" onclick="closeFilterInputModal()">Cancelar</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modal);
    document.getElementById('route-to-input').focus();
    lockBodyScroll();
}

function updateRouteToSuggestions(query, fromStop) {
    const availableStops = getAvailableStopsForFilter();
    const suggestions = availableStops.filter(stop =>
        stop.toLowerCase().includes(query.toLowerCase())
    );

    const container = document.getElementById('route-to-suggestions');

    if (query && suggestions.length > 0) {
        container.innerHTML = suggestions.slice(0, 5).map(stop => `
            <button class="suggestion-item" onclick="selectRouteToStop('${fromStop}', '${stop}')">
                ${stop}
            </button>
        `).join('');
        container.classList.remove('hidden');
    } else {
        container.classList.add('hidden');
    }
}

function selectRouteToStop(fromStop, toStop) {
    closeFilterInputModal();

    const seats = getSeatsInRoute(fromStop, toStop);

    if (seats.length === 0) {
        alert(`No hay viajeros en el tramo ${fromStop} - ${toStop}`);
        return;
    }

    showConfirmModal(
        `Se encontraron ${seats.length} viajero(s) en el tramo\n` +
        `${fromStop} → ${toStop}\n\n` +
        `¿Deseas resaltarlos visualmente en la plantilla?`,
        () => {
            // Si acepta
            const seatKeys = seats.map(s => getSeatKey(s.coach, s.seat));
            filterState.type = 'route';
            applyFilterHighlight(seatKeys);
            showRouteFilterResults(fromStop, toStop, seats);
        },
        () => {
            // Si cancela, solo mostrar resultados
            showRouteFilterResults(fromStop, toStop, seats);
        }
    );
}

function openSeatFilter() {
    toggleFiltersMenu();

    const modal = `
        <div class="modal-overlay" onclick="closeFilterInputModal(event)">
            <div class="modal about-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <div class="modal-header-top">
                        <h3 class="modal-title">Filtrar por asiento</h3>
                        <button class="close-btn" onclick="closeFilterInputModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="filter-input-content">
                    <label class="filter-input-label">Introduce el número de asiento:</label>
                    <input 
                        type="text" 
                        id="seat-filter-input" 
                        class="filter-text-input"
                        placeholder="Ej: 42"
                        onkeypress="if(event.key==='Enter') searchSeatFilter()"
                    />
                </div>
                <div class="modal-footer">
                    <button class="clear-btn" style="background-color: #4f46e5;" onclick="searchSeatFilter()">Buscar</button>
                    <button class="clear-btn" onclick="closeFilterInputModal()">Cancelar</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modal);
    document.getElementById('seat-filter-input').focus();
    lockBodyScroll();
}

function searchSeatFilter() {
    const input = document.getElementById('seat-filter-input');
    const seatNum = input.value.trim();

    if (!seatNum) return;

    closeFilterInputModal();

    const seatInfo = getSeatInfo(seatNum);

    if (!seatInfo) {
        alert(`No se encontró información para el asiento ${seatNum}`);
        return;
    }

    showSeatFilterResults(seatInfo);
}

function closeFilterInputModal(event) {
    if (!event || event.target === event.currentTarget) {
        const modal = document.querySelector('.about-modal')?.closest('.modal-overlay');
        if (modal) modal.remove();
    }
}

function showConfirmModal(message, onConfirm, onCancel) {
    const modal = `
        <div class="modal-overlay" onclick="closeConfirmModal(false, event)">
            <div class="modal confirm-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3 class="modal-title">Confirmar</h3>
                </div>
                <div class="confirm-content">
                    <p>${message.replace(/\n/g, '<br>')}</p>
                </div>
                <div class="modal-footer confirm-footer">
                    <button class="confirm-btn cancel-btn" onclick="closeConfirmModal(false)">
                        Cancelar
                    </button>
                    <button class="confirm-btn accept-btn" onclick="closeConfirmModal(true)">
                        Aceptar
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modal);

    // Guardar callbacks
    window._confirmCallbacks = { onConfirm, onCancel };
    lockBodyScroll();
}

function closeConfirmModal(accepted, event) {
    if (event && event.target !== event.currentTarget) return;

    const modal = document.querySelector('.confirm-modal')?.closest('.modal-overlay');
    if (modal) {
        modal.remove();

        const callbacks = window._confirmCallbacks;
        if (callbacks) {
            if (accepted && callbacks.onConfirm) {
                callbacks.onConfirm();
            } else if (!accepted && callbacks.onCancel) {
                callbacks.onCancel();
            }
            window._confirmCallbacks = null;
        }
    }
}

function showStopFilterResults(stopName, seats) {
    // Agrupar por coche
    const byCoach = {};
    seats.forEach(s => {
        if (!byCoach[s.coach]) byCoach[s.coach] = [];
        byCoach[s.coach].push(s.seat);
    });

    let details = '';
    Object.keys(byCoach).sort().forEach(coach => {
        details += `\n${coach}: ${byCoach[coach].sort((a, b) => {
            const numA = parseInt(String(a).replace(/\D/g, ''));
            const numB = parseInt(String(b).replace(/\D/g, ''));
            return numA - numB;
        }).join(', ')}`;
    });

    const modal = `
        <div class="modal-overlay" onclick="closeFilterModal(event)">
            <div class="modal filter-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3 class="modal-title">Asientos con destino a ${stopName}</h3>
                    <button class="close-btn" onclick="closeFilterModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="filter-results">
                    <p><strong>Total: ${seats.length} asiento(s)</strong></p>
                    <pre>${details}</pre>
                </div>
                <div class="modal-footer">
                    <button class="clear-btn" onclick="closeFilterModal()">Cerrar</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modal);
    lockBodyScroll();
}

function showRouteFilterResults(fromStop, toStop, seats) {
    const byCoach = {};
    seats.forEach(s => {
        if (!byCoach[s.coach]) byCoach[s.coach] = [];
        byCoach[s.coach].push(s.seat);
    });

    let details = '';
    Object.keys(byCoach).sort().forEach(coach => {
        details += `\n${coach}: ${byCoach[coach].sort((a, b) => {
            const numA = parseInt(String(a).replace(/\D/g, ''));
            const numB = parseInt(String(b).replace(/\D/g, ''));
            return numA - numB;
        }).join(', ')}`;
    });

    const modal = `
        <div class="modal-overlay" onclick="closeFilterModal(event)">
            <div class="modal filter-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3 class="modal-title">Viajeros en tramo</h3>
                    <p style="font-size: 0.9rem; margin-top: 0.5rem;">${fromStop} → ${toStop}</p>
                    <button class="close-btn" onclick="closeFilterModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="filter-results">
                    <p><strong>Total: ${seats.length} viajero(s)</strong></p>
                    <pre>${details}</pre>
                </div>
                <div class="modal-footer">
                    <button class="clear-btn" onclick="closeFilterModal()">Cerrar</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modal);
    lockBodyScroll();
}

function showSeatFilterResults(seatInfo) {
    const { coach, seat, data } = seatInfo;

    let info = `Coche: ${coach}\nAsiento: ${seat}\n\n`;

    if (data.stop) {
        info += `Destino: ${data.stop.full}\n`;
    } else {
        info += `Sin destino asignado\n`;
    }

    if (data.enlace) info += `✓ Enlace\n`;
    if (data.seguir) info += `✓ Seguir por aquí\n`;
    if (data.comentario) info += `\nComentario:\n${data.comentario}\n`;
    if (data.historial && data.historial.length > 0) {
        info += `\nHistorial: ${data.historial.join(' → ')}`;
    }

    const modal = `
        <div class="modal-overlay" onclick="closeFilterModal(event)">
            <div class="modal filter-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3 class="modal-title">Información del asiento ${seat}</h3>
                    <button class="close-btn" onclick="closeFilterModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="filter-results">
                    <pre>${info}</pre>
                </div>
                <div class="modal-footer">
                    <button class="clear-btn" onclick="closeFilterModal()">Cerrar</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modal);
    lockBodyScroll();
}

function closeFilterModal(event) {
    if (!event || event.target === event.currentTarget) {
        const modal = document.querySelector('.filter-modal')?.closest('.modal-overlay');
        if (modal) modal.remove();
    }
}

// Toggle del menú de filtros
function toggleFiltersMenu() {
    const menu = document.getElementById('filters-menu');
    if (menu) {
        menu.classList.toggle('hidden');
    }
}

// Estado de la aplicación
let state = {
    selectedTrain: "463",
    selectedCoach: "C1",
    seatData: {},
    selectedSeat: null,
    searchQuery: "",
    trainDirection: {},
    darkMode: false,
    trainNumber: null,
    rotateSeats: false,
    currentStop: null,
    currentStopSearch: '',
    headerCollapsed: false,
    coachPositions: {}
};

// Estado para filtros
let filterState = {
    active: false,
    type: null, // 'stop', 'route', 'seat'
    data: null
};

// Variables para long tap en asientos
let seatHoldTimer = null;
let seatHoldTriggered = false;
const SEAT_LONG_PRESS_DURATION = 500; // 500ms para long tap
// Variables para detectar scroll vs tap
let touchStartX = 0;
let touchStartY = 0;
let isScrolling = false;
const SCROLL_THRESHOLD = 5; // píxeles de movimiento para considerar scroll

// Variables para mantener scroll del modal
let modalScrollPosition = 0;

// Cargar datos guardados
function loadData() {
    // Cargar último tren usado
    const savedTrain = localStorage.getItem("selectedTrain");
    if (savedTrain && trainModels[savedTrain]) {
        state.selectedTrain = savedTrain;
    }

    // Cargar datos de asientos del tren actual
    const saved = localStorage.getItem(`train${state.selectedTrain}Data`);
    if (saved) {
        try {
            state.seatData = JSON.parse(saved);
        } catch (e) {
            console.error("Error loading data");
        }
    }

    // Cargar dirección del tren actual
    const savedDirection = localStorage.getItem(
        `train${state.selectedTrain}Direction`
    );
    if (savedDirection) {
        try {
            state.trainDirection = JSON.parse(savedDirection);
        } catch (e) {
            console.error("Error loading direction");
        }
    }

    // Inicializar dirección si no existe (dirección por defecto "up")
    const currentTrain = trainModels[state.selectedTrain];
    currentTrain.coaches.forEach(coach => {
        if (!state.trainDirection[coach.id]) {
            state.trainDirection[coach.id] = "up";
        }
    });

    // Cargar modo nocturno
    const savedDarkMode = localStorage.getItem("darkMode");
    if (savedDarkMode) {
        state.darkMode = savedDarkMode === "true";
    }
    // Cargar rotación guardada
    const savedRotation = localStorage.getItem("rotateSeats");
    if (savedRotation) {
        state.rotateSeats = savedRotation === "true";
    }
    // Cargar número de tren
    const savedTrainNumber = localStorage.getItem('trainNumber');
    if (savedTrainNumber) {
        state.trainNumber = savedTrainNumber;
    }
    // Cargar parada actual
    const savedCurrentStop = localStorage.getItem('currentStop');
    if (savedCurrentStop) {
        state.currentStop = savedCurrentStop;
    }
    // Cargar estado del header
    const savedHeaderState = localStorage.getItem('headerCollapsed');
    if (savedHeaderState) {
        state.headerCollapsed = savedHeaderState === 'true';
    }
}

// Guardar datos
function saveData() {
    localStorage.setItem(
        `train${state.selectedTrain}Data`,
        JSON.stringify(state.seatData)
    );
}

// Obtener clave del asiento
function getSeatKey(coachId, seatNum) {
    return `${coachId}-${String(seatNum)}`;
}

// Actualizar asiento
function updateSeat(coachId, seatNum, stop) {
    const key = getSeatKey(coachId, String(seatNum));
    if (!state.seatData[key]) {
        state.seatData[key] = {};
    }
    state.seatData[key].stop = stop;
    saveData();
    state.selectedSeat = null;
    state.searchQuery = "";
    render();
}

function updateSeatFromList(abbr) {
    const stop = stops.find((s) => s.abbr === abbr);
    if (stop && state.selectedSeat) {
        updateSeat(state.selectedSeat.coach, state.selectedSeat.num, stop);
        closeModal(); // 👈 se asegura de desbloquear el scroll correctamente
    }
}

// Borrar asiento
function clearSeat(coachId, seatNum) {
    // Convertir a string para manejar tanto números como strings tipo 'PMR-97'
    const key = getSeatKey(coachId, String(seatNum));
    delete state.seatData[key];
    saveData();
    state.selectedSeat = null;
    render();
}

function toggleFlag(coachId, seatNum, flagName) {
    const key = getSeatKey(coachId, seatNum);
    if (!state.seatData[key]) {
        state.seatData[key] = {};
    }
    state.seatData[key][flagName] = !state.seatData[key][flagName];

    // Si desmarca comentarioFlag, borrar el comentario
    if (flagName === "comentarioFlag" && !state.seatData[key][flagName]) {
        delete state.seatData[key].comentario;
    }

    saveData();

    // Guardar posición del scroll antes de renderizar
    saveModalScrollPosition();
    render();
    // Restaurar posición del scroll después de renderizar
    restoreModalScrollPosition();
}

function updateComment(coachId, seatNum, comment) {
    const key = getSeatKey(coachId, seatNum);
    if (!state.seatData[key]) {
        state.seatData[key] = {};
    }
    state.seatData[key].comentario = comment;
    saveData();
}

function deleteComment(coachId, seatNum) {
    const key = getSeatKey(coachId, seatNum);
    if (state.seatData[key]) {
        delete state.seatData[key].comentario;
        state.seatData[key].comentarioFlag = false;
    }
    saveData();

    // Guardar posición del scroll antes de renderizar
    saveModalScrollPosition();
    render();
    // Restaurar posición del scroll después de renderizar
    restoreModalScrollPosition();
}

function toggleDirection(coachId) {
    // Obtener dirección actual del coche seleccionado
    const current = state.trainDirection[coachId] || "up";
    const newDirection = current === "up" ? "down" : "up";

    // Aplicar la misma dirección a TODOS los coches del tren actual
    const currentTrain = trainModels[state.selectedTrain];
    currentTrain.coaches.forEach(coach => {
        state.trainDirection[coach.id] = newDirection;
    });

    localStorage.setItem(
        `train${state.selectedTrain}Direction`,
        JSON.stringify(state.trainDirection)
    );
    render();
}

function selectTrain(trainId) {
    if (trainModels[trainId]) {
        state.selectedTrain = trainId;
        state.selectedCoach = trainModels[trainId].coaches[0].id;
        state.seatData = {};
        state.trainDirection = {};
        state.selectedSeat = null;
        state.searchQuery = "";
        state.coachPositions = {};

        localStorage.setItem("selectedTrain", trainId);

        // Cargar datos del nuevo tren
        const saved = localStorage.getItem(`train${trainId}Data`);
        if (saved) {
            try {
                state.seatData = JSON.parse(saved);
            } catch (e) {
                console.error("Error loading data");
            }
        }

        const savedDirection = localStorage.getItem(`train${trainId}Direction`);
        if (savedDirection) {
            try {
                state.trainDirection = JSON.parse(savedDirection);
            } catch (e) {
                console.error("Error loading direction");
            }
        }

        render();
    }
    // Cerrar el menú después de cambiar de tren
    setTimeout(() => {
        const selector = document.getElementById('train-selector');
        if (selector && !selector.classList.contains('hidden')) {
            selector.classList.add('hidden');
        }
    }, 50);
}

function toggleTrainSelector() {
    const selector = document.getElementById("train-selector");
    if (selector) {
        selector.classList.toggle("hidden");
    }
}

function toggleDarkMode() {
    state.darkMode = !state.darkMode;
    localStorage.setItem("darkMode", state.darkMode);
    document.body.classList.toggle("dark-mode", state.darkMode);
    render(); // 🔥 Esto vuelve a pintar el header con el nuevo icono
}

function toggleSeatRotation() {
    // Cambiar el estado
    state.rotateSeats = !state.rotateSeats;
    localStorage.setItem("rotateSeats", state.rotateSeats);

    // Aplicar o quitar clase visual
    const container = document.querySelector('.seats-container');
    if (container) {
        container.classList.toggle('rotated', state.rotateSeats);
    }

    // NO cambiar la dirección del tren, solo rotar visualmente
    // Pero SÍ volver a renderizar para actualizar las flechas del pasillo

    // Volver a renderizar (esto actualizará las flechas)
    render();
}

function showTrainNumberPrompt() {
    const currentNumber = state.trainNumber || '';
    const input = prompt('Introduce el número de tren:', currentNumber);

    if (input === null) return; // canceló

    const trimmed = input.trim();
    if (trimmed === '') {
        alert('Por favor, introduce un número de tren válido');
        return;
    }

    // Si el número es distinto del actual, confirmamos y borramos datos previos
    if (trimmed !== state.trainNumber) {
        // Si no está en la lista, preguntar si quiere usarlo (igual que antes)
        if (!trainNumbers[trimmed]) {
            const confirmUnknown = confirm(
                `El número de tren "${trimmed}" no está en la lista.\n¿Deseas usarlo de todos modos?\n\n(No se aplicará esquina doblada automáticamente)`
            );
            if (!confirmUnknown) return;
        }

        // --- BORRAR DATOS DE LA SESIÓN ANTERIOR ---
        // 1) Eliminar del state los asientos guardados (sesión actual: selectedTrain)
        state.seatData = {};
        // 2) Eliminar direcciones guardadas del tren (opcional/seguro)
        state.trainDirection = {};

        // 3) Eliminar las claves de localStorage relativas al tren que estaba en uso
        //    Usamos state.selectedTrain (modelo: 463, 464...) porque el guardado por asiento
        //    se hace por selectedTrain: `train${state.selectedTrain}Data`.
        try {
            localStorage.removeItem(`train${state.selectedTrain}Data`);
            localStorage.removeItem(`train${state.selectedTrain}Direction`);
        } catch (e) {
            console.warn('No se pudo eliminar las claves antiguas de localStorage', e);
        }

        // También podemos eliminar currentStop (si quieres que se resetee)
        // localStorage.removeItem('currentStop');
        // state.currentStop = null;

        // Guardar inmediatamente (creará una entrada vacía si tu saveData lo hace así)
        saveData();
    } else {
        // Si el número es el mismo, no borramos nada — normal behaviour
        if (!trainNumbers[trimmed]) {
            const confirmUnknown = confirm(
                `El número de tren "${trimmed}" no está en la lista.\n¿Deseas usarlo de todos modos?\n\n(No se aplicará esquina doblada automáticamente)`
            );
            if (!confirmUnknown) return;
        }
    }

    // Finalmente: actualizar estado y persistir número
    state.trainNumber = trimmed;
    try {
        localStorage.setItem('trainNumber', trimmed);
    } catch (e) {
        console.warn('No se pudo guardar trainNumber en localStorage', e);
    }

    // Re-renderizar la UI para reflejar el cambio
    render();
}

function getTrainFinalStops() {
    if (!state.trainNumber) return [];
    return trainNumbers[state.trainNumber] || [];
}

function setCurrentStop(stopName) {
    if (!state.trainNumber || !trainRoutes[state.trainNumber]) {
        alert('Primero debes seleccionar un número de tren válido');
        return;
    }

    const route = trainRoutes[state.trainNumber];
    const stopIndex = route.indexOf(stopName);

    if (stopIndex === -1) {
        alert('Esta parada no está en la ruta del tren ' + state.trainNumber);
        return;
    }

    // Guardar parada actual
    state.currentStop = stopName;
    localStorage.setItem('currentStop', stopName);

    // Obtener todas las paradas hasta la actual (inclusive)
    const stopsToDelete = route.slice(0, stopIndex + 1);

    // Recorrer todos los asientos y borrar los que tengan paradas anteriores
    let deletedCount = 0;
    Object.keys(state.seatData)
        .forEach(key => {
            const seatInfo = state.seatData[key];
            if (seatInfo && seatInfo.stop) {
                if (stopsToDelete.includes(seatInfo.stop.full)) {
                    // Guardar en historial antes de borrar
                    if (!seatInfo.historial) {
                        seatInfo.historial = [];
                    }
                    seatInfo.historial.push(seatInfo.stop.full);

                    // Borrar TODO: parada, flags, comentarios
                    delete seatInfo.stop;
                    delete seatInfo.enlace;
                    delete seatInfo.seguir;
                    delete seatInfo.comentario;
                    delete seatInfo.comentarioFlag;

                    // Si no queda nada más que el historial, podemos dejarlo
                    // El asiento vuelve a su estado inicial (solo con historial)

                    deletedCount++;
                }
            }
        });

    saveData();
    state.currentStopSearch = '';
    render();

    alert(`Parada actual: ${stopName}\n${deletedCount} asiento(s) liberado(s)`);
}

function getCurrentRoute() {
    if (!state.trainNumber) return [];
    return trainRoutes[state.trainNumber] || [];
}

function filterCurrentStops() {
    const query = state.currentStopSearch.toLowerCase();
    const route = getCurrentRoute();
    return route.filter(stop => stop.toLowerCase()
        .includes(query));
}

function updateCurrentStopSearch(value) {
    state.currentStopSearch = value;

    // Buscar el contenedor del selector
    const container = document.querySelector('.current-stop-selector');
    if (!container) return;

    // Eliminar dropdown anterior si existe
    const oldDropdown = container.querySelector('.current-stop-dropdown');
    if (oldDropdown) {
        oldDropdown.remove();
    }

    // Si hay texto y resultados, crear nuevo dropdown
    const filtered = filterCurrentStops();
    if (value && filtered.length > 0) {
        const dropdownHTML = `
            <div class="current-stop-dropdown">
                ${filtered.slice(0, 5).map(stop => `
                    <button class="stop-option" onclick="setCurrentStop('${stop}')">
                        ${stop}
                    </button>
                `).join('')}
            </div>
        `;
        container.insertAdjacentHTML('beforeend', dropdownHTML);
        const dd = container.querySelector('.current-stop-dropdown');
        if (dd) {
            // Bloquea propagación normal
            dd.addEventListener(
                'wheel',
                (e) => {
                    // Lógica para evitar scroll “de fuga” al llegar al borde
                    const atTop = dd.scrollTop === 0;
                    const atBottom =
                        dd.scrollHeight - dd.clientHeight === Math.ceil(dd.scrollTop);

                    if ((atTop && e.deltaY < 0) || (atBottom && e.deltaY > 0)) {
                        e.preventDefault();      // Evitar desplazamiento de fondo
                    }
                    e.stopPropagation();
                },
                { passive: false }
            );

            dd.addEventListener(
                'touchmove',
                (e) => {
                    const atTop = dd.scrollTop === 0;
                    const atBottom =
                        dd.scrollHeight - dd.clientHeight === Math.ceil(dd.scrollTop);

                    const touch = e.touches[0];
                    const deltaY = (dd._lastTouchY || touch.clientY) - touch.clientY;
                    dd._lastTouchY = touch.clientY;

                    if ((atTop && deltaY < 0) || (atBottom && deltaY > 0)) {
                        e.preventDefault();
                    }
                    e.stopPropagation();
                },
                { passive: false }
            );
        }


    }
}

function toggleHeaderCollapse() {
    state.headerCollapsed = !state.headerCollapsed;
    localStorage.setItem('headerCollapsed', state.headerCollapsed);
    render();
}

function openAbout() {
    const aboutHTML = `
        <div class="modal-overlay" onclick="closeAbout(event)">
            <div class="modal about-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <div class="modal-header-top">
                        <h3 class="modal-title">Acerca de</h3>
                        <button class="close-btn" onclick="closeAbout()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="about-content">
                    <p><strong>plantillaTren v1.0</strong></p>
                    <p>Creado por Adrián Fernández,</p>
<p>y publicado bajo la licencia MIT.</p>
                    <p>Dudas o sugerencias a:<br><a href="mailto:plantillatren@gmail.com">plantillatren@gmail.com</a></p>
                </div>
                <div class="modal-footer">
                    <button class="clear-btn" onclick="closeAbout()">Cerrar</button>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', aboutHTML);
    lockBodyScroll();
}

function closeAbout(event) {
    if (!event || event.target === event.currentTarget) {
        const overlay = document.querySelector('.about-modal')
            ?.closest('.modal-overlay');
        if (overlay) overlay.remove();
    }
}

function exportTurn() {
    const turnData = {
        trainModel: state.selectedTrain,
        seatData: state.seatData,
        trainDirection: state.trainDirection,
        exportDate: new Date()
            .toISOString(),
        trainName: trainModels[state.selectedTrain].name,
    };

    const dataStr = JSON.stringify(turnData, null, 2);
    const dataBlob = new Blob([dataStr], {
        type: "application/json"
    });

    const link = document.createElement("a");
    link.href = URL.createObjectURL(dataBlob);

    const date = new Date();
    const dateStr = `${date.getFullYear()}-${String(
        date.getMonth() + 1
    ).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
    const timeStr = `${String(date.getHours()).padStart(2, "0")}-${String(
        date.getMinutes()
    ).padStart(2, "0")}`;

    link.download = `turno-${state.selectedTrain}-${dateStr}-${timeStr}.json`;
    link.click();

    URL.revokeObjectURL(link.href);
}

function importTurn() {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".json";

    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const turnData = JSON.parse(event.target.result);

                // Verificar que el archivo sea válido
                if (!turnData.trainModel || !trainModels[turnData.trainModel]) {
                    alert(
                        "Archivo de turno no válido o modelo de tren no reconocido"
                    );
                    return;
                }

                // Confirmar importación
                const trainName = turnData.trainName || turnData.trainModel;
                const exportDate = turnData.exportDate ?
                    new Date(turnData.exportDate)
                    .toLocaleString("es-ES") :
                    "desconocida";

                if (
                    confirm(
                        `¿Importar turno del ${trainName}?\nFecha de exportación: ${exportDate}\n\nEsto reemplazará los datos actuales de este tren.`
                    )
                ) {
                    // Cambiar al tren correcto si es necesario
                    if (state.selectedTrain !== turnData.trainModel) {
                        state.selectedTrain = turnData.trainModel;
                        state.selectedCoach =
                            trainModels[turnData.trainModel].coaches[0].id;
                        localStorage.setItem(
                            "selectedTrain",
                            turnData.trainModel
                        );
                    }

                    // Importar datos
                    state.seatData = turnData.seatData || {};
                    state.trainDirection = turnData.trainDirection || {};

                    // Guardar
                    localStorage.setItem(
                        `train${state.selectedTrain}Data`,
                        JSON.stringify(state.seatData)
                    );
                    localStorage.setItem(
                        `train${state.selectedTrain}Direction`,
                        JSON.stringify(state.trainDirection)
                    );

                    // Recargar vista
                    render();

                    alert("Turno importado correctamente");
                }
            } catch (error) {
                alert(
                    "Error al leer el archivo. Asegúrate de que sea un archivo de turno válido."
                );
                console.error("Error importing turn:", error);
            }
        };
        reader.readAsText(file);
    };

    input.click();
}

// Borrar todos los datos
function clearAllData() {
    if (confirm("¿Seguro que quieres borrar todos los datos?")) {
        state.seatData = {};
        localStorage.removeItem("train463Data");
        render();
    }
}

// Filtrar paradas
function getFilteredStops() {
    const query = state.searchQuery.toLowerCase();

    // Si hay número de tren, filtrar solo las paradas de esa ruta
    let availableStops = stops;
    if (state.trainNumber && trainRoutes[state.trainNumber]) {
        const routeStops = trainRoutes[state.trainNumber];
        availableStops = stops.filter(stop => routeStops.includes(stop.full));
    }

    return availableStops.filter(
        (stop) =>
        stop.full.toLowerCase()
        .includes(query) ||
        stop.abbr.toLowerCase()
        .includes(query)
    );
}

// Renderizar header
function renderHeader() {
    const currentTrain = trainModels[state.selectedTrain];
    const currentCoach = currentTrain.coaches.find(
        (c) => c.id === state.selectedCoach
    );

    return `
        <div class="header ${state.headerCollapsed ? 'collapsed' : ''}">
            ${!state.headerCollapsed ? `
                <div class="header-main">
                    <div class="header-row-1">
                        <div class="header-left">
    <svg class="train-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="4" y="6" width="16" height="12" rx="2"/>
        <path d="M4 11h16M12 6v5"/>
        <circle cx="9" cy="16" r="1"/>
        <circle cx="15" cy="16" r="1"/>
    </svg>
    <div class="header-title-group">
        <button class="title train-selector-btn" onclick="toggleTrainSelector()">
            ${currentTrain.name} ▼
        </button>
        <div id="train-selector" class="train-selector-dropdown hidden">
            ${Object.entries(trainModels)
        .map(
            ([id, train]) => `
                <button
                    class="train-option ${
                state.selectedTrain === id ? "active" : ""
            }"
                    onclick="selectTrain('${id}'); toggleTrainSelector();"
                >
                    ${train.name}
                </button>
            `
        )
        .join("")}
        </div>
    </div>

${state.trainNumber ? `
    <div style="position: relative;">
        <button class="filters-btn" onclick="toggleFiltersMenu()" title="Filtros">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
            </svg>
        </button>
        <div id="filters-menu" class="filters-dropdown hidden">
            <button class="filter-option" onclick="openStopFilter()">
                Por parada de bajada
            </button>
            <button class="filter-option" onclick="openRouteFilter()">
                Por tramo recorrido
            </button>
            <button class="filter-option" onclick="openSeatFilter()">
                Por asiento
            </button>
        </div>
    </div>
` : ''}
</div>

<div class="header-right">
    ${filterState.active ? `
        <button class="filter-clear-pill" onclick="clearFilterHighlight()" title="Limpiar filtro">
            ×
        </button>
    ` : ''}
    ${state.trainNumber ? `
        <button class="train-number-display" onclick="showTrainNumberPrompt()">
            Nº ${state.trainNumber}
        </button>
    ` : ''}
</div>
                    </div>

                    ${state.trainNumber && trainRoutes[state.trainNumber] ? `
                        <div class="current-stop-row">
                            <div class="current-stop-selector">
                                <label class="current-stop-label">Parada actual:</label>
                                <input
                                    type="text"
                                    class="current-stop-input"
                                    placeholder="${state.currentStop || 'Seleccionar...'}"
                                    value="${state.currentStopSearch}"
                                    oninput="updateCurrentStopSearch(this.value)"
                                    onfocus="this.select()"
                                />
                                ${state.currentStopSearch && filterCurrentStops().length > 0 ? `
                                    <div class="current-stop-dropdown">
                                        ${filterCurrentStops().slice(0, 5).map(stop => `
                                            <button class="stop-option" onclick="setCurrentStop('${stop}')">
                                                ${stop}
                                            </button>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <div class="header-actions">
                        <button class="action-btn" onclick="toggleDarkMode()" title="Modo nocturno">
                            ${state.darkMode ? `
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="5"/>
                                    <line x1="12" y1="1" x2="12" y2="3"/>
                                    <line x1="12" y1="21" x2="12" y2="23"/>
                                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                                    <line x1="1" y1="12" x2="3" y2="12"/>
                                    <line x1="21" y1="12" x2="23" y2="12"/>
                                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                                </svg>
                            ` : `
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                                </svg>
                            `}
                        </button>
                        <button class="action-btn" onclick="openAbout()" title="Acerca de">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="16" x2="12" y2="12"/>
                                <line x1="12" y1="8" x2="12" y2="8"/>
                            </svg>
                        </button>
                        <button class="action-btn" onclick="toggleSeatRotation()" title="Invertir disposición de asientos">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2v20M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <button class="action-btn" onclick="exportTurn()" title="Exportar turno">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                        </button>
                        <button class="action-btn" onclick="importTurn()" title="Importar turno">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                        </button>
                        <button class="action-btn delete-btn" onclick="clearAllData()" title="Borrar todos los datos">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                <line x1="10" y1="11" x2="10" y2="17"/>
                                <line x1="14" y1="11" x2="14" y2="17"/>
                            </svg>
                        </button>
                    </div>
                </div>
            ` : ''}

            <div class="coach-selector-row">
                <button class="header-collapse-btn" onclick="toggleHeaderCollapse()" title="${state.headerCollapsed ? 'Expandir' : 'Colapsar'} header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        ${state.headerCollapsed ?
                            '<polyline points="6 9 12 15 18 9"/>' :
                            '<polyline points="18 15 12 9 6 15"/>'
                        }
                    </svg>
                </button>
                <div class="coach-selector">
                    ${currentTrain.coaches
        .map((coach) => {
            // ------------- CALCULAR OCUPACIÓN -------------
            const coachId = coach.id;

            // claves de asientos que pertenecen a este coche
            const seatKeys = Object.keys(state.seatData || {})
                .filter(k => k.startsWith(`${coachId}-`));

            // total de asientos reales en este coche
            const totalSeats = coach.layout
                .flatMap(block => block.type === "seats" ? block.positions : [])
                .flat()
                .filter(n => typeof n === "number").length;

            // asientos ocupados (que tienen parada asignada)
            const occupiedSeats = seatKeys.filter(k => state.seatData[k]?.stop).length;

            const occPercent = totalSeats > 0
                ? Math.round((occupiedSeats / totalSeats) * 100)
                : 0;

            // determinar clase de ocupación
            let occClass = "";
            if (occPercent <= 35) occClass = "occ-low";
            else if (occPercent <= 70) occClass = "occ-mid";
            else occClass = "occ-high";

            // ------------- DEVUELVE EL BOTÓN -------------
            return `
            <button
                class="coach-btn ${occClass} ${
                state.selectedCoach === coach.id ? "active" : ""
            }"
                onclick="selectCoach('${coach.id}')"
            >
                ${coach.id}
            </button>`;
        })
        .join("")}
                </div>
            </div>
        </div>
    `;
}

// Renderizar asientos
function renderSeats() {
    const currentTrain = trainModels[state.selectedTrain];
    const currentCoach = currentTrain.coaches.find(
        (c) => c.id === state.selectedCoach
    );

    const firstCoach = currentTrain.coaches[0].id;
    const lastCoach = currentTrain.coaches[currentTrain.coaches.length - 1].id;

    let html = "";

    html += '<div class="seats-layout">';

    // CABEZA/COLA al inicio
    if (currentCoach.id === firstCoach) {
        const label = getCabinaLabel(currentCoach.id);
        html += `<div class="cabina-label">${label}</div>`;
    }

    currentCoach.layout.forEach((section) => {
        if (section.type === "pmr-bathroom") {
            const label = section.label || "BAÑO PMR";
            html += `<div class="pmr-bathroom" style="height: ${section.height}px">${label}</div>`;
            return;
        }
        if (section.type === "space") {
            html += `<div class="space" style="height: ${section.height}px"></div>`;
        } else {
            html += '<div class="seat-group">';
            section.positions.forEach((row) => {
                html += '<div class="seat-row">';
                row.forEach((seatNum, index) => {
                    if (seatNum === null) {
                        // Solo mostrar flecha si es el elemento central (índice 2 en array de 5)
                        const isCentralAisle = (row.length === 5 && index === 2);
                        if (isCentralAisle) {
                            const arrow = getAisleArrow(currentCoach.id);
                            html += `<div class="seat empty-space aisle-arrow">${arrow}</div>`;
                        } else {
                            // Espacio vacío normal sin flecha
                            html += '<div class="seat empty-space"></div>';
                        }
                    } else if (seatNum === "EQ" || seatNum === "WC" || seatNum === "MIN" || seatNum === "MESA") {
                        // Asientos especiales no clickeables
                        html += `<div class="seat special-non-clickable">${seatNum}</div>`;
                    } else {
                        const key = getSeatKey(state.selectedCoach, seatNum);
                        const seatInfo = state.seatData[key];

                        let seatClass = '';
                        let seatStyle = '';
                        let label = seatNum;
                        let isFinalStop = false;

// Aplicar filtro visual si está activo
                        let isFiltered = false;

                        if (filterState.active && filterState.data) {
                            isFiltered = filterState.data.includes(key);
                        }

// Si el asiento está filtrado, ponerlo en rojo
                        if (isFiltered) {
                            seatClass = 'filtered-seat';
                        } else if (seatInfo) {
                            // Recopilar colores activos
                            const colors = [];
                            if (seatInfo.stop) colors.push('#22c55e');
                            if (seatInfo.enlace) colors.push('#3b82f6');
// aceptar tanto comentarioFlag como comentario (texto)
                            if (seatInfo.comentarioFlag || seatInfo.comentario) colors.push('#f97316');
                            if (seatInfo.seguir) colors.push('#eab308');


                            // Verificar si es parada final según el número de tren
                            const finalStopsForTrain = getTrainFinalStops();
                            isFinalStop = seatInfo.stop && finalStopsForTrain.includes(seatInfo.stop.full);

                            if (colors.length > 1) {
                                // Crear degradado dividido
                                const percentage = 100 / colors.length;
                                const gradientStops = colors.map((color, index) => {
                                    const start = index * percentage;
                                    const end = (index + 1) * percentage;
                                    return `${color} ${start}%, ${color} ${end}%`;
                                })
                                    .join(', ');

                                seatStyle = `background: linear-gradient(to right, ${gradientStops});`;
                                seatClass = 'multi-color';
                            } else if (colors.length === 1) {
                                // Un solo color
                                if (seatInfo.comentarioFlag || seatInfo.comentario) {
                                    seatClass = 'orange';
                                } else if (seatInfo.enlace) {
                                    seatClass = 'blue';
                                } else if (seatInfo.seguir) {
                                    seatClass = 'yellow';
                                } else if (seatInfo.stop) {
                                    seatClass = 'occupied';
                                }
                            }
                        }

                        const isPMR = String(seatNum).includes("PMR");
                        const displayNum = isPMR ?
                            String(seatNum).replace("PMR-", "") :
                            seatNum;

                        if (seatInfo && seatInfo.stop) {
                            label = `${seatInfo.stop.abbr}<br><small style="font-size:0.6rem;">${displayNum}</small>`;
                        }

                        const pmrClass = isPMR ? "pmr-seat" : "";
                        const finalStopClass = isFinalStop ? 'final-stop' : '';
                        // Determinar clase de filtro
                        const filterClass = (filterState.active && !isFiltered) ? 'filtered-out' : '';

                        html += `
    <button
        class="seat ${seatClass} ${pmrClass} ${finalStopClass} ${filterClass}"
        style="${seatStyle}"
        onmousedown="handleSeatPress('${state.selectedCoach}', '${seatNum}', event)"
        onmousemove="handleSeatMove('${state.selectedCoach}', '${seatNum}', event)"
        onmouseup="handleSeatRelease('${state.selectedCoach}', '${seatNum}', event)"
        onmouseleave="handleSeatCancel()"
        ontouchstart="handleSeatPress('${state.selectedCoach}', '${seatNum}', event)"
        ontouchmove="handleSeatMove('${state.selectedCoach}', '${seatNum}', event)"
        ontouchend="handleSeatRelease('${state.selectedCoach}', '${seatNum}', event)"
        ontouchcancel="handleSeatCancel()"
    >
        ${label}
    </button>
`;
                    }
                });
                html += "</div>"; // seat-row
            });
            html += "</div>"; // seat-group
        }
    });

    // CABEZA/COLA al final
    if (currentCoach.id === lastCoach) {
        const label = getCabinaLabel(currentCoach.id);
        html += `<div class="cabina-label">${label}</div>`;
    }

    html += "</div>"; // seats-layout

    return html;
}

// Renderizar modal
// Renderizar modal
function renderModal() {
    if (!state.selectedSeat) return "";

    const key = getSeatKey(state.selectedSeat.coach, state.selectedSeat.num);
    const currentStop = state.seatData[key]?.stop;
    const filteredStops = getFilteredStops();

    return `
        <div class="modal-overlay" 
             onclick="closeModal(event)"
             onmousedown="handleModalOverlayInteraction(event)"
             ontouchstart="handleModalOverlayInteraction(event)"
             ontouchend="closeModal(event)">
            <div class="modal" 
                 onclick="event.stopPropagation()"
                 onmousedown="event.stopPropagation()"
                 ontouchstart="modalSwipeStart(event); event.stopPropagation()"
                 ontouchmove="modalSwipeMove(event)"
                 ontouchend="modalSwipeEnd(event)"
                 ontouchcancel="modalSwipeEnd(event)">
                <div class="modal-header">
                    <div class="modal-header-top">
                        <h3 class="modal-title">Asiento ${
        state.selectedSeat.num
    } - ${state.selectedSeat.coach}</h3>
                    </div>
                    ${
        state.seatData[key]?.historial && state.seatData[key].historial.length > 0
            ? `
                        <div class="seat-history">
                            Asiento liberado en: ${state.seatData[key].historial.join(' → ')}
                        </div>`
            : ""
    }
                    <button class="close-btn" onclick="closeModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                ${
        currentStop
            ? `<div class="current-stop">Se baja en: ${currentStop.full}</div>`
            : ""
    }
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input
                            type="checkbox"
                            id="enlace-check"
                            ${state.seatData[key]?.enlace ? "checked" : ""}
                            onchange="toggleFlag('${state.selectedSeat.coach}', '${state.selectedSeat.num}', 'enlace')"
                        />
                        <label for="enlace-check">Enlace</label>
                    </div>
                    <div class="checkbox-item">
                        <input
                            type="checkbox"
                            id="comentario-check"
                            ${state.seatData[key]?.comentarioFlag ? "checked" : ""}
                            onchange="toggleFlag('${state.selectedSeat.coach}', '${state.selectedSeat.num}', 'comentarioFlag'); render();"
                        />
                        <label for="comentario-check">Comentario</label>
                    </div>
                    ${
        state.seatData[key]?.comentarioFlag
            ? `
                        <div class="comment-box">
                            <textarea
                                class="comment-input"
                                rows="3"
                                placeholder="Escribe un comentario."
                                oninput="saveModalScrollPosition(); updateComment('${state.selectedSeat.coach}', '${state.selectedSeat.num}', this.value)"
                                onfocus="saveModalScrollPosition()"
                            >${state.seatData[key]?.comentario || ""}</textarea>
                            <button class="delete-comment-btn" onclick="deleteComment('${state.selectedSeat.coach}', '${state.selectedSeat.num}')">
                                Borrar comentario
                            </button>
                        </div>
                    `
            : ""
    }
                    <div class="checkbox-item">
                        <input
                            type="checkbox"
                            id="seguir-check"
                            ${state.seatData[key]?.seguir ? "checked" : ""}
                            onchange="toggleFlag('${state.selectedSeat.coach}', '${state.selectedSeat.num}', 'seguir')"
                        />
                        <label for="seguir-check">Seguir por aquí</label>
                    </div>
                </div>
                <div class="modal-search">
                    <input
                        type="text"
                        class="search-input"
                        placeholder="Buscar parada."
                        value="${state.searchQuery}"
                        oninput="updateSearch(this.value)"
                        readonly onfocus="this.removeAttribute('readonly')"
                    />
                </div>
                <div class="modal-list">
                    ${filteredStops
        .map(
            (stop) => `
                        <button
                            class="stop-item"
                            onclick="updateSeatFromList('${stop.abbr}')"
                        >
                            <span class="stop-name">${stop.full}</span>
                            <span class="stop-abbr">${stop.abbr}</span>
                        </button>
                    `
        )
        .join("")}
                </div>
                ${
        currentStop
            ? `
                <div class="modal-footer">
                    <button class="clear-btn" onclick="clearSeat('${state.selectedSeat.coach}', '${state.selectedSeat.num}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="6" x2="21" y2="6"/>
                            <line x1="10" y1="11" x2="10" y2="17"/>
                            <line x1="14" y1="11" x2="14" y2="17"/>
                        </svg>
                        Liberar asiento
                    </button>
                </div>
                `
            : ""
    }
            </div>
        </div>
    `;
}

// Renderizar todo
function render() {
    // --- evitar flash en modo oscuro durante el render inicial ---
    const body = document.body;
    body.style.transition = "none";

    // reactivar transición tras el primer frame (una vez pintado)
    requestAnimationFrame(() => {
        body.style.transition = "";
    });
    // Aplicar modo oscuro al body
    document.body.classList.toggle("dark-mode", state.darkMode);
    const app = document.getElementById("app");
    app.innerHTML = `
    ${renderHeader()}
    <div class="seats-container ${state.rotateSeats ? 'rotated' : ''}">
            ${renderSeats()}
            <div class="legend">
    <div class="legend-content">
        <div class="legend-item">
            <div class="legend-box free"></div>
            <span>Libre</span>
        </div>
        <div class="legend-item">
            <div class="legend-box checked"></div>
            <span>Revisado</span>
        </div>
        <div class="legend-item">
            <div class="legend-box blue"></div>
            <span>Enlace</span>
        </div>
        <div class="legend-item">
            <div class="legend-box orange"></div>
            <span>Comentario</span>
        </div>
        <div class="legend-item">
            <div class="legend-box yellow"></div>
            <span>Continuar</span>
        </div>
<div class="legend-item">
            <div class="legend-box checked final-stop-legend"></div>
            <span>Fin trayecto</span>
        </div>
<div class="direction-control">
    <button class="direction-btn-bottom" onclick="toggleDirection('${state.selectedCoach}')" title="Cambiar dirección del tren">
        <div class="direction-icon">${state.trainDirection[state.selectedCoach] === 'down' ? '↓' : '↑'}</div>
        <div class="direction-label">Dirección del tren</div>
    </button>
</div>
    </div>
</div>
        </div>
        ${renderModal()}
    `;
    // Restaurar scroll del modal si existe
    if (state.selectedSeat) {
        restoreModalScrollPosition();
    } else {
        // Si cerramos el modal, resetear la posición guardada
        modalScrollPosition = 0;
    }
}

function saveModalScrollPosition() {
    const modalList = document.querySelector('.modal-list');
    if (modalList) {
        modalScrollPosition = modalList.scrollTop;
    }
}

function restoreModalScrollPosition() {
    // Usar requestAnimationFrame para asegurar que el DOM está actualizado
    requestAnimationFrame(() => {
        const modalList = document.querySelector('.modal-list');
        if (modalList && modalScrollPosition > 0) {
            modalList.scrollTop = modalScrollPosition;
        }
    });
}

// Referencias globales para poder remover los listeners
let modalTouchMoveHandler = null;
let modalTouchEndHandler = null;

// ========== NUEVO SISTEMA DE SCROLL SIMPLIFICADO ==========

// Prevenir scroll en overlay del modal (solo en el overlay, no globalmente)
function handleModalOverlayInteraction(e) {
    // Solo actuar si el click/touch es directamente en el overlay
    if (e.target.classList.contains('modal-overlay')) {
        e.preventDefault();
    }
}

// No necesitamos más funciones de scroll complejas
// El navegador manejará el scroll naturalmente

// ========== FIN SISTEMA SIMPLIFICADO ==========


// Funciones globales para eventos
function selectCoach(coachId) {
    state.selectedCoach = coachId;
    render();
}

function selectSeat(coach, num) {
    state.selectedSeat = {
        coach,
        num
    };
    state.searchQuery = "";
    lockBodyScroll(); // Solo bloquear body
    render();
    // ✅ NO llamar a setupModalScroll()
}

function lockBodyScroll() {
    const scrollY = window.scrollY;
    document.body.classList.add('modal-open'); // ✅ AÑADIR
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollY}px`;
    document.body.style.width = '100%';
}

function setupModalListScrollGuards() {
    // Remover listeners previos si existen
    removeModalScrollGuards();

    // wheel (ratón / trackpad)
    modalWheelHandler = (e) => {
        const list = e.target.closest('.modal-list');
        if (!list) return;

        const atTop = list.scrollTop === 0;
        const atBottom = Math.ceil(list.scrollTop) === list.scrollHeight - list.clientHeight;

        if ((atTop && e.deltaY < 0) || (atBottom && e.deltaY > 0)) {
            e.preventDefault();
        }

        e.stopPropagation();
    };

    // touchmove (móvil)
    modalTouchMoveHandler = (e) => {
        const list = e.target.closest('.modal-list');
        if (!list) return;

        const touch = e.touches[0];
        const lastY = list._lastTouchY ?? touch.clientY;
        const deltaY = lastY - touch.clientY;
        list._lastTouchY = touch.clientY;

        const atTop = list.scrollTop === 0;
        const atBottom = Math.ceil(list.scrollTop) === list.scrollHeight - list.clientHeight;

        if ((atTop && deltaY < 0) || (atBottom && deltaY > 0)) {
            e.preventDefault();
        }

        e.stopPropagation();
    };

    // touchend/cancel
    modalTouchEndHandler = (e) => {
        const list = e.target.closest('.modal-list');
        if (list) list._lastTouchY = null;
    };

    // Añadir listeners
    document.addEventListener('wheel', modalWheelHandler, { passive: false, capture: true });
    document.addEventListener('touchmove', modalTouchMoveHandler, { passive: false, capture: true });
    document.addEventListener('touchend', modalTouchEndHandler, { capture: true });
    document.addEventListener('touchcancel', modalTouchEndHandler, { capture: true });
}

// ✅ NUEVA FUNCIÓN: Remover listeners cuando se cierra el modal
function removeModalScrollGuards() {
    if (modalWheelHandler) {
        document.removeEventListener('wheel', modalWheelHandler, { capture: true });
        modalWheelHandler = null;
    }
    if (modalTouchMoveHandler) {
        document.removeEventListener('touchmove', modalTouchMoveHandler, { capture: true });
        modalTouchMoveHandler = null;
    }
    if (modalTouchEndHandler) {
        document.removeEventListener('touchend', modalTouchEndHandler, { capture: true });
        document.removeEventListener('touchcancel', modalTouchEndHandler, { capture: true });
        modalTouchEndHandler = null;
    }
}

// Referencias globales para overlay
let overlayWheelHandler = null;
let overlayTouchMoveHandler = null;

function setupModalOverlayScrollBlock() {
    // Remover listeners previos
    removeModalOverlayScrollBlock();

    const scrollableSelectors = ['.modal-list', '.comment-input', '.current-stop-dropdown'];

    // Prevenir scroll en el modal excepto en áreas específicas
    overlayTouchMoveHandler = (e) => {
        const overlay = e.target.closest('.modal-overlay');
        if (!overlay) return;

        const isInScrollable = scrollableSelectors.some(selector =>
            e.target.closest(selector)
        );

        if (!isInScrollable) {
            e.preventDefault();
            e.stopPropagation();
        }
    };

    overlayWheelHandler = (e) => {
        const overlay = e.target.closest('.modal-overlay');
        if (!overlay) return;

        const isInScrollable = scrollableSelectors.some(selector =>
            e.target.closest(selector)
        );

        if (!isInScrollable) {
            e.preventDefault();
            e.stopPropagation();
        }
    };

    document.addEventListener('touchmove', overlayTouchMoveHandler, { passive: false, capture: true });
    document.addEventListener('wheel', overlayWheelHandler, { passive: false, capture: true });
}

// ✅ NUEVA FUNCIÓN: Remover listeners de overlay
function removeModalOverlayScrollBlock() {
    if (overlayTouchMoveHandler) {
        document.removeEventListener('touchmove', overlayTouchMoveHandler, { capture: true });
        overlayTouchMoveHandler = null;
    }
    if (overlayWheelHandler) {
        document.removeEventListener('wheel', overlayWheelHandler, { capture: true });
        overlayWheelHandler = null;
    }
}

function unlockBodyScroll() {
    const scrollY = document.body.style.top;
    document.body.classList.remove('modal-open');
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.width = '';

    // Restaurar posición de scroll
    window.scrollTo(0, parseInt(scrollY || '0') * -1);
}

function handleSeatPress(coach, num, event) {
    const key = getSeatKey(coach, num);
    if (filterState.active && filterState.data && !filterState.data.includes(key)) {
        return;
    }

    const seatInfo = state.seatData[key];

    // Guardar posición inicial del toque
    if (event.type === 'touchstart') {
        const touch = event.touches[0];
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
        isScrolling = false;
    } else if (event.type === 'mousedown') {
        touchStartX = event.clientX;
        touchStartY = event.clientY;
        isScrolling = false;
    }

    seatHoldTriggered = false;
    clearTimeout(seatHoldTimer);

    // Iniciar timer para long press
    seatHoldTimer = setTimeout(() => {
        // Solo activar long press si NO estamos haciendo scroll
        if (!isScrolling) {
            seatHoldTriggered = true;

            const key = getSeatKey(coach, num);
            const seatInfo = state.seatData[key];

            // 🔴 Caso 1: el asiento tiene datos → BORRAR (como antes)
            if (seatInfo && Object.keys(seatInfo).length > 0) {
                // Verificar si tiene historial para preservarlo
                const hasHistory = seatInfo.historial && seatInfo.historial.length > 0;

                // Si tiene parada, guardarla en el historial antes de borrar
                if (seatInfo.stop && !hasHistory) {
                    if (!seatInfo.historial) {
                        seatInfo.historial = [];
                    }
                    seatInfo.historial.push(seatInfo.stop.full);
                }

                // Borrar el asiento completamente
                clearSeat(coach, num);

                // Feedback visual/háptico opcional
                if (navigator.vibrate) {
                    navigator.vibrate(50); // Vibración corta en móviles
                }

                // 🟢 Caso 2: asiento vacío → asignar última parada del tren
            } else {
                // Necesitamos saber la ruta del tren actual
                const route = state.trainNumber && trainRoutes[state.trainNumber];

                if (route && route.length > 0) {
                    // Última parada de la ruta (por ejemplo, Zaragoza Miraflores o Castejón)
                    const finalStopName = route[route.length - 1];

                    // Buscar ese nombre en el array global de paradas "stops"
                    const stopObj = stops.find(s => s.full === finalStopName);

                    if (stopObj) {
                        // Asignar parada al asiento SIN abrir modal
                        updateSeat(coach, num, stopObj);

                        // Vibración un pelín más corta para diferenciarlo si quieres
                        if (navigator.vibrate) {
                            navigator.vibrate(30);
                        }
                    }
                }
                // Si no hay trainNumber o ruta definida, simplemente no hace nada
            }
        }
    }, SEAT_LONG_PRESS_DURATION);
}

function handleSeatMove(coach, num, event) {
    // Calcular distancia del movimiento
    let currentX, currentY;

    if (event.type === 'touchmove') {
        const touch = event.touches[0];
        currentX = touch.clientX;
        currentY = touch.clientY;
    } else if (event.type === 'mousemove') {
        currentX = event.clientX;
        currentY = event.clientY;
    } else {
        return;
    }

    const deltaX = Math.abs(currentX - touchStartX);
    const deltaY = Math.abs(currentY - touchStartY);

    // Si el movimiento supera el umbral, es scroll
    if (deltaX > SCROLL_THRESHOLD || deltaY > SCROLL_THRESHOLD) {
        isScrolling = true;
        clearTimeout(seatHoldTimer);
        seatHoldTriggered = false;
        // NO prevenir aquí - dejar que el scroll funcione naturalmente
    }
}

function handleSeatRelease(coach, num, event) {
    clearTimeout(seatHoldTimer);

    // Si NO fue long press Y NO estamos haciendo scroll, abrir modal
    if (!seatHoldTriggered && !isScrolling) {
        // Solo prevenir si vamos a abrir el modal
        event.preventDefault();
        selectSeat(coach, num);
    }

    // Resetear estados
    seatHoldTriggered = false;
    isScrolling = false;
}

function handleSeatCancel() {
    clearTimeout(seatHoldTimer);
    seatHoldTriggered = false;
    isScrolling = false;
}

function closeModal(event) {
    if (!event || event.target === event.currentTarget) {
        // Solo desbloquear body
        unlockBodyScroll();

        // Resetear estado
        state.selectedSeat = null;
        state.searchQuery = "";
        modalScrollPosition = 0;

        render();
    }
}

// --- Swipe down para cerrar modal con rebote ---

let modalSwipeStartY = 0;
let modalSwipeDeltaY = 0;
let modalSwipeActive = false;
const MODAL_SWIPE_CLOSE_THRESHOLD = 80; // px necesarios para cerrar

function modalSwipeStart(event) {
    if (!event.touches || event.touches.length === 0) return;

    // Solo activamos el swipe si el gesto empieza en el header del modal
    const header = event.target.closest('.modal-header');
    if (!header) {
        modalSwipeActive = false;
        return;
    }

    modalSwipeActive = true;
    const touch = event.touches[0];
    modalSwipeStartY = touch.clientY;
    modalSwipeDeltaY = 0;

    const modal = document.querySelector('.modal');
    if (modal) {
        modal.style.transition = 'none';
        modal.style.animation = '';
    }
}

function modalSwipeMove(event) {
    if (!modalSwipeActive || !event.touches || event.touches.length === 0) return;

    const touch = event.touches[0];
    const deltaY = touch.clientY - modalSwipeStartY;

    // Solo nos interesa si se mueve hacia abajo
    if (deltaY <= 0) {
        modalSwipeDeltaY = 0;
        return;
    }

    modalSwipeDeltaY = deltaY;

    const modal = document.querySelector('.modal');
    if (modal) {
        const limited = Math.min(deltaY, 200); // límite para que no se vaya a Cuenca
        modal.style.transform = `translateY(${limited}px)`;
    }
}

function modalSwipeEnd(event) {
    if (!modalSwipeActive) return;
    modalSwipeActive = false;

    const modal = document.querySelector('.modal');
    if (!modal) {
        modalSwipeDeltaY = 0;
        return;
    }

    // Si hemos arrastrado suficiente, cerramos el modal deslizando hacia abajo
    if (modalSwipeDeltaY > MODAL_SWIPE_CLOSE_THRESHOLD) {
        modal.style.transition = 'transform 0.2s ease-out';
        modal.style.transform = 'translateY(100%)';

        // Una vez termina la animación, cerramos de verdad
        setTimeout(() => {
            modal.style.transition = '';
            modal.style.transform = '';
            closeModal(); // sin evento → pasa la condición de closeModal
        }, 200);
    } else {
        // No llega al umbral → animación de rebote
        modal.style.transition = '';
        modal.style.setProperty('--modal-swipe-distance', `${modalSwipeDeltaY}px`);
        modal.style.animation = 'modalReturnBounce 0.25s ease-out';

        modal.addEventListener(
            'animationend',
            () => {
                modal.style.animation = '';
                modal.style.transform = '';
                modal.style.removeProperty('--modal-swipe-distance');
            },
            { once: true }
        );
    }

    modalSwipeDeltaY = 0;
}

function updateSearch(value) {
    state.searchQuery = value;
    // Solo actualizar la lista de paradas, no todo
    const modalList = document.querySelector(".modal-list");
    if (modalList) {
        const filteredStops = getFilteredStops();
        modalList.innerHTML = filteredStops
            .map(
                (stop) => `
            <button
                class="stop-item"
                onclick="updateSeatFromList('${stop.abbr}')"
            >
                <span class="stop-name">${stop.full}</span>
                <span class="stop-abbr">${stop.abbr}</span>
            </button>
        `
            )
            .join("");
    }
}

// --- Swipe lateral en la plantilla + cambio de coche con fade --- //
let __touchStartX = 0, __touchStartY = 0, __touchStartTime = 0;
const __SWIPE_X_THRESHOLD = 50;   // px mínimos en horizontal
const __SWIPE_Y_MAX = 40;         // desvío vertical máximo
const __SWIPE_TIME_MAX = 800;     // ms máximos de gesto

function __getAdjacentCoachId(direction) {
    // Nos basamos en el orden visual de los botones .coach-btn
    const btns = Array.from(document.querySelectorAll('.coach-btn'));
    const i = btns.findIndex(b => b.classList.contains('active'));
    if (i === -1) return null;
    const nextIndex = direction === 'next' ? i + 1 : i - 1;
    const targetBtn = btns[nextIndex];
    return targetBtn ? targetBtn.textContent.trim() : null;
}

function __changeCoachWithFade(direction) {
    const targetId = __getAdjacentCoachId(direction);
    if (!targetId) return;

    const seatMap = document.querySelector('.seats-layout');
    if (seatMap) {
        // Fade out actual
        seatMap.classList.add('fade-out');

        setTimeout(() => {
            // Cambiar de coche (tu función pública ya expuesta)
            selectCoach(targetId);

            // Tras render, quitar fade en el nuevo contenedor
            requestAnimationFrame(() => {
                const newSeatMap = document.querySelector('.seats-layout');
                if (newSeatMap) {
                    // forzamos reflow para asegurar transición
                    void newSeatMap.offsetWidth;
                    newSeatMap.classList.remove('fade-out');
                }
            });
        }, 150); // Igual a .15s del CSS
    } else {
        // Fallback si no se encontró el contenedor
        selectCoach(targetId);
    }
}

function enableSeatmapSwipe() {
    const seatMap = document.querySelector('.seats-layout');
    if (!seatMap || seatMap.dataset.swipeBound === '1') return; // evitas duplicados
    seatMap.dataset.swipeBound = '1';

    seatMap.addEventListener('touchstart', (e) => {
        const t = e.changedTouches[0];
        __touchStartX = t.clientX;
        __touchStartY = t.clientY;
        __touchStartTime = Date.now();
    }, { passive: true });

    seatMap.addEventListener('touchend', (e) => {
        const t = e.changedTouches[0];
        const dx = t.clientX - __touchStartX;
        const dy = t.clientY - __touchStartY;
        const dt = Date.now() - __touchStartTime;

        const isHorizontal = Math.abs(dx) >= __SWIPE_X_THRESHOLD && Math.abs(dy) <= __SWIPE_Y_MAX;
        const isFastEnough = dt <= __SWIPE_TIME_MAX;

        if (isHorizontal && isFastEnough) {
            if (dx < 0) __changeCoachWithFade('next'); // swipe izquierda -> siguiente coche
            else __changeCoachWithFade('prev');        // swipe derecha -> coche anterior
        }
    });
}
// --- fin swipe + fade --- //

// --- PRESIONADO LARGO EN BOTONES DE COCHE (versión corregida) ---
let coachHoldTimer = null;
let coachHoldTriggered = false;

function enableCoachLongPress() {
    const buttons = document.querySelectorAll(".coach-btn");

    buttons.forEach(btn => {
        const coachId = btn.textContent.trim();

        // Cuando se inicia la pulsación
        btn.addEventListener("mousedown", startPress);
        btn.addEventListener("touchstart", startPress, { passive: true });

        // Cuando se suelta o cancela
        btn.addEventListener("mouseup", endPress);
        btn.addEventListener("touchend", endPress);
        btn.addEventListener("touchcancel", endPress);

        // IMPORTANTE: mouseleave solo debe cancelar el timer, NO ejecutar nada
        btn.addEventListener("mouseleave", cancelPress);

        function startPress(e) {
            coachHoldTriggered = false;
            clearTimeout(coachHoldTimer);
            coachHoldTimer = setTimeout(() => {
                coachHoldTriggered = true;
                showCoachStats(coachId);
            }, 600);
        }

        function endPress(e) {
            clearTimeout(coachHoldTimer);

            // Si NO se activó el long press → comportamiento normal (click)
            if (!coachHoldTriggered) {
                selectCoach(coachId);
            }

            // Reiniciar flag
            coachHoldTriggered = false;
        }

        function cancelPress(e) {
            // Solo cancelar el timer, NO ejecutar selectCoach
            clearTimeout(coachHoldTimer);
            coachHoldTriggered = false;
        }
    });
}

// Muestra la ventanita con número de asientos ocupados/libres (versión corregida)
function showCoachStats(coachId) {
    // 1) Intentar obtener la definición del coche desde trainModels
    const train = trainModels[state.selectedTrain];
    let coachDef = null;
    if (train && Array.isArray(train.coaches)) {
        coachDef = train.coaches.find(c => String(c.id) === String(coachId));
    }

    // 2) Obtén lista de IDs de asiento del layout (si existe), si no, fallback a keys en state
    let seatIds = [];

    if (coachDef && Array.isArray(coachDef.layout)) {
        coachDef.layout.forEach(block => {
            if (block.type === 'seats' && Array.isArray(block.positions)) {
                block.positions.forEach(row => {
                    row.forEach(cell => {
                        if (cell === null) return;
                        // Normalizamos a string
                        const sid = String(cell);
                        // Excluir marcadores no-asiento (WC, EQ, MESA, etc.) — amplia si tienes más
                        const nonSeatMarkers = ['WC', 'EQ', 'MESA', 'PMR', 'ESPACIO', 'BANO', 'BAÑO'];
                        if (nonSeatMarkers.includes(sid.toUpperCase())) return;
                        seatIds.push(sid);
                    });
                });
            }
        });
    }

    // Fallback: si no hemos obtenido asientos desde layout, construir lista desde state.seatData keys
    if (seatIds.length === 0) {
        const keys = Object.keys(state.seatData || {});
        const prefix = `${coachId}-`;
        keys.forEach(k => {
            if (k.startsWith(prefix)) {
                // extraer parte posterior (por ejemplo C1-12 -> 12)
                const idPart = k.slice(prefix.length);
                seatIds.push(String(idPart));
            }
        });
        // Si aún así no hay nada, como último recurso usamos los botones de DOM (si existen)
    }

    // Evitar duplicados
    seatIds = Array.from(new Set(seatIds));

    const total = seatIds.length;

    // 3) Contar ocupados: existe state.seatData[getSeatKey(coachId, seatId)] con .stop
    let occupied = 0;
    seatIds.forEach(id => {
        try {
            const key = getSeatKey(coachId, id);
            if (state.seatData && state.seatData[key] && state.seatData[key].stop) {
                occupied += 1;
            }
        } catch (e) {
            // no romper si getSeatKey no está disponible (debería estar)
            console.warn('showCoachStats: error comprobando asiento', e);
        }
    });

    const free = Math.max(0, total - occupied);

    // 4) Mostrar popup (igual que antes, centrado)
    const popup = document.createElement("div");
    popup.className = "coach-popup";
    popup.innerHTML = `
  <div class="coach-popup-content">
    <strong>${coachId}</strong><br>
    Ocupados: ${occupied}<br>
    Libres: ${free}<br>
    Porcentaje: ${total > 0 ? Math.round((occupied / total) * 100) : 0}%
  </div>
`;

    document.body.appendChild(popup);

    popup.style.position = "fixed";
    popup.style.top = "50%";
    popup.style.left = "50%";
    popup.style.transform = "translate(-50%, -50%)";
    popup.style.zIndex = "9999";

    setTimeout(() => popup.remove(), 2500);
}

// Reaplicar después de render (los botones se regeneran)
document.addEventListener("DOMContentLoaded", enableCoachLongPress);
const domObserver = new MutationObserver(() => {
    enableCoachLongPress();
    enableSeatmapSwipe();
});
domObserver.observe(document.body, { childList: true, subtree: true });

// Inicializar
window.selectCoach = selectCoach;
window.selectSeat = selectSeat;
window.closeModal = closeModal;
window.updateSearch = updateSearch;
window.clearSeat = clearSeat;
window.clearAllData = clearAllData;
window.updateSeat = updateSeat;
window.updateSeatFromList = updateSeatFromList;
window.toggleFlag = toggleFlag;
window.updateComment = updateComment;
window.deleteComment = deleteComment;
window.toggleDirection = toggleDirection;
window.selectTrain = selectTrain;
window.toggleTrainSelector = toggleTrainSelector;
window.exportTurn = exportTurn;
window.importTurn = importTurn;
window.toggleDarkMode = toggleDarkMode;
window.toggleSeatRotation = toggleSeatRotation;
window.openAbout = openAbout;
window.closeAbout = closeAbout;
window.showTrainNumberPrompt = showTrainNumberPrompt;
window.setCurrentStop = setCurrentStop;
window.updateCurrentStopSearch = updateCurrentStopSearch;
window.toggleHeaderCollapse = toggleHeaderCollapse;
window.handleSeatPress = handleSeatPress;
window.handleSeatRelease = handleSeatRelease;
window.handleSeatCancel = handleSeatCancel;
window.handleSeatMove = handleSeatMove;
window.toggleFiltersMenu = toggleFiltersMenu;
window.openStopFilter = openStopFilter;
window.openRouteFilter = openRouteFilter;
window.openSeatFilter = openSeatFilter;
window.clearFilterHighlight = clearFilterHighlight;
window.closeFilterModal = closeFilterModal;
window.updateStopFilterSuggestions = updateStopFilterSuggestions;
window.selectStopForFilter = selectStopForFilter;
window.updateRouteFromSuggestions = updateRouteFromSuggestions;
window.selectRouteFromStop = selectRouteFromStop;
window.updateRouteToSuggestions = updateRouteToSuggestions;
window.selectRouteToStop = selectRouteToStop;
window.searchSeatFilter = searchSeatFilter;
window.closeFilterInputModal = closeFilterInputModal;
window.showConfirmModal = showConfirmModal;
window.closeConfirmModal = closeConfirmModal;
window.saveModalScrollPosition = saveModalScrollPosition;
window.restoreModalScrollPosition = restoreModalScrollPosition;
// Scroll management
window.handleModalOverlayInteraction = handleModalOverlayInteraction;
window.lockBodyScroll = lockBodyScroll;
window.unlockBodyScroll = unlockBodyScroll;
window.modalSwipeStart = modalSwipeStart;
window.modalSwipeMove = modalSwipeMove;
window.modalSwipeEnd = modalSwipeEnd;

function setupModalScrollBehavior() {
    // Prevenir scroll en overlay excepto en áreas scrolleables
    ['wheel', 'touchmove'].forEach(eventType => {
        document.addEventListener(eventType, (e) => {
            const overlay = e.target.closest('.modal-overlay');
            if (!overlay) return;

            const scrollableSelectors = ['.modal-list', '.comment-input', '.current-stop-dropdown'];
            const isInScrollable = scrollableSelectors.some(sel => e.target.closest(sel));

            if (!isInScrollable) {
                e.preventDefault();
                e.stopPropagation();
                return;
            }

            // Lógica específica para modal-list
            const list = e.target.closest('.modal-list');
            if (list) {
                const atTop = list.scrollTop === 0;
                const atBottom = Math.ceil(list.scrollTop) === list.scrollHeight - list.clientHeight;

                if (eventType === 'wheel') {
                    if ((atTop && e.deltaY < 0) || (atBottom && e.deltaY > 0)) {
                        e.preventDefault();
                    }
                } else { // touchmove
                    const touch = e.touches[0];
                    const lastY = list._lastTouchY ?? touch.clientY;
                    const deltaY = lastY - touch.clientY;
                    list._lastTouchY = touch.clientY;

                    if ((atTop && deltaY < 0) || (atBottom && deltaY > 0)) {
                        e.preventDefault();
                    }
                }
                e.stopPropagation();
            }
        }, { passive: false, capture: true });
    });

    // Limpiar memoria del último toque
    ['touchend', 'touchcancel'].forEach(type => {
        document.addEventListener(type, (e) => {
            const list = e.target.closest('.modal-list');
            if (list) list._lastTouchY = null;
        }, { capture: true });
    });
}

// Inicializar
loadData();

// Mostrar prompt de número de tren si no existe
if (!state.trainNumber) {
    // Esperar un momento para que se cargue el DOM
    setTimeout(() => {
        showTrainNumberPrompt();
    }, 100);
}

render();

// Tras el primer render, engancha swipe
enableSeatmapSwipe();