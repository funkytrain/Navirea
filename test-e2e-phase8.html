<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test E2E - Fase 8 (Pulido y Documentaci√≥n)</title>

    <!-- Cargar estilos de wizard para verificar tooltips y templates -->
    <link rel="stylesheet" href="css/components/wizard.css">
    <link rel="stylesheet" href="css/components/config-manager.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .test-section {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .test-header {
            background: #3498db;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 16px;
        }

        .test-content {
            padding: 20px;
        }

        .test-case {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .test-case h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .test-case p {
            color: #555;
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.5;
        }

        .test-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .result {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.6;
        }

        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .code {
            background: #2c3e50;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin-top: 10px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-success {
            background: #27ae60;
            color: white;
        }

        .badge-warning {
            background: #f39c12;
            color: white;
        }

        .badge-info {
            background: #3498db;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test E2E - Fase 8: Pulido y Documentaci√≥n</h1>
        <p class="subtitle">Suite completa de testing para verificar templates, tooltips y funcionalidad completa del sistema</p>

        <div class="progress-bar">
            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalTests">0</div>
                <div class="stat-label">Total de Tests</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="passedTests">0</div>
                <div class="stat-label">Tests Exitosos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="failedTests">0</div>
                <div class="stat-label">Tests Fallidos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="customConfigs">0</div>
                <div class="stat-label">Configs Personalizadas</div>
            </div>
        </div>

        <!-- Test 1: Templates -->
        <div class="test-section">
            <div class="test-header">Test 1: Verificar Sistema de Templates</div>
            <div class="test-content">
                <div class="test-case">
                    <h3>1.1 - Cargar templates predefinidos</h3>
                    <p>Verifica que TrainTemplates est√© disponible y tenga 5 templates.</p>
                    <div class="test-actions">
                        <button class="btn btn-primary" onclick="test1_1()">Ejecutar Test</button>
                    </div>
                    <div id="result-1-1"></div>
                </div>

                <div class="test-case">
                    <h3>1.2 - Crear modelo desde template "Regional 3 Coches"</h3>
                    <p>Crea un modelo usando el template predefinido y verifica que tenga 3 coches.</p>
                    <div class="test-actions">
                        <button class="btn btn-primary" onclick="test1_2()">Ejecutar Test</button>
                    </div>
                    <div id="result-1-2"></div>
                </div>

                <div class="test-case">
                    <h3>1.3 - Verificar contenido del template "Suburban 4 Coches"</h3>
                    <p>Verifica que el template Suburbano tenga 4 coches y disposici√≥n 3+2.</p>
                    <div class="test-actions">
                        <button class="btn btn-primary" onclick="test1_3()">Ejecutar Test</button>
                    </div>
                    <div id="result-1-3"></div>
                </div>
            </div>
        </div>

        <!-- Test 2: Tooltips y Ayudas -->
        <div class="test-section">
            <div class="test-header">Test 2: Verificar Tooltips y Ayudas Contextuales</div>
            <div class="test-content">
                <div class="test-case">
                    <h3>2.1 - Verificar estilos CSS de tooltips</h3>
                    <p>Verifica que las clases CSS para tooltips est√©n definidas.</p>
                    <div class="test-actions">
                        <button class="btn btn-primary" onclick="test2_1()">Ejecutar Test</button>
                    </div>
                    <div id="result-2-1"></div>
                </div>

                <div class="test-case">
                    <h3>2.2 - Abrir wizard y verificar tooltips visualmente</h3>
                    <p>Abre el wizard de creaci√≥n de modelo y verifica que se muestren los iconos de ayuda (?).</p>
                    <div class="test-actions">
                        <button class="btn btn-success" onclick="test2_2()">Abrir Wizard</button>
                        <button class="btn btn-secondary" onclick="closeWizard()">Cerrar Wizard</button>
                    </div>
                    <div id="result-2-2"></div>
                </div>
            </div>
        </div>

        <!-- Test 3: Flujo Completo -->
        <div class="test-section">
            <div class="test-header">Test 3: Flujo Completo de Creaci√≥n</div>
            <div class="test-content">
                <div class="test-case">
                    <h3>3.1 - Crear modelo desde template, editarlo y guardarlo</h3>
                    <p>Crea un modelo desde el template "Intercity 2 Coches", personaliza el nombre y gu√°rdalo.</p>
                    <div class="test-actions">
                        <button class="btn btn-warning" onclick="test3_1()">Ejecutar Flujo Completo</button>
                    </div>
                    <div id="result-3-1"></div>
                </div>

                <div class="test-case">
                    <h3>3.2 - Verificar que el modelo se guard√≥ correctamente</h3>
                    <p>Verifica que el modelo creado en 3.1 existe en ConfigurationManager.</p>
                    <div class="test-actions">
                        <button class="btn btn-primary" onclick="test3_2()">Verificar</button>
                    </div>
                    <div id="result-3-2"></div>
                </div>
            </div>
        </div>

        <!-- Test 4: Integraci√≥n UI -->
        <div class="test-section">
            <div class="test-header">Test 4: Integraci√≥n con UI Principal</div>
            <div class="test-content">
                <div class="test-case">
                    <h3>4.1 - Verificar templates en selector de modelos</h3>
                    <p>Abre el Configuration Manager y verifica que se puedan crear modelos desde templates.</p>
                    <div class="test-actions">
                        <button class="btn btn-success" onclick="test4_1()">Abrir Gestor</button>
                    </div>
                    <div id="result-4-1"></div>
                </div>

                <div class="test-case">
                    <h3>4.2 - Verificar gu√≠a de usuario existe</h3>
                    <p>Verifica que el archivo USER_GUIDE.md fue creado correctamente.</p>
                    <div class="test-actions">
                        <button class="btn btn-primary" onclick="test4_2()">Verificar</button>
                    </div>
                    <div id="result-4-2"></div>
                </div>
            </div>
        </div>

        <!-- Test 5: Limpieza -->
        <div class="test-section">
            <div class="test-header">Test 5: Limpieza de Datos de Prueba</div>
            <div class="test-content">
                <div class="test-case">
                    <h3>5.1 - Eliminar configuraciones de prueba</h3>
                    <p>Elimina todas las configuraciones personalizadas creadas durante los tests.</p>
                    <div class="test-actions">
                        <button class="btn btn-danger" onclick="test5_1()">Limpiar Tests</button>
                        <button class="btn btn-warning" onclick="resetAll()">Resetear TODO</button>
                    </div>
                    <div id="result-5-1"></div>
                </div>
            </div>
        </div>

        <!-- Botones Globales -->
        <div style="margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
            <button class="btn btn-success" onclick="runAllTests()" style="font-size: 16px; padding: 12px 24px;">
                ‚ñ∂Ô∏è Ejecutar Todos los Tests
            </button>
            <button class="btn btn-secondary" onclick="updateStats()" style="font-size: 16px; padding: 12px 24px;">
                üîÑ Actualizar Estad√≠sticas
            </button>
        </div>
    </div>

    <!-- Cargar todas las dependencias -->
    <script>
        // Funciones auxiliares necesarias para ConfigurationManagerUI
        window.lockBodyScroll = function() {
            document.body.style.overflow = 'hidden';
        };
        window.unlockBodyScroll = function() {
            document.body.style.overflow = '';
        };
    </script>
    <script src="src/utils/id-generator.js"></script>
    <script src="src/utils/config-validator.js"></script>
    <script src="src/services/StorageService.js"></script>
    <script src="src/utils/data-loader.js"></script>
    <script src="src/services/ConfigurationManager.js"></script>
    <script src="src/utils/train-templates.js"></script>
    <script src="src/components/ElementPalette.js"></script>
    <script src="src/components/SeatRowEditor.js"></script>
    <script src="src/components/LayoutPreview.js"></script>
    <script src="src/components/SeatLayoutEditor.js"></script>
    <script src="src/wizards/WizardCore.js"></script>
    <script src="src/wizards/TrainModelWizard.js"></script>
    <script src="src/wizards/RouteWizard.js"></script>
    <script src="src/components/ConfigurationManagerUI.js"></script>

    <script>
        // ====================================================================
        // VARIABLES GLOBALES
        // ====================================================================
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0
        };

        // ====================================================================
        // FUNCIONES DE UTILIDAD
        // ====================================================================
        function showResult(elementId, success, message) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.className = `result ${success ? 'success' : 'error'}`;
            resultDiv.innerHTML = success
                ? `‚úÖ <strong>√âXITO:</strong> ${message}`
                : `‚ùå <strong>ERROR:</strong> ${message}`;

            testResults.total++;
            if (success) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }
            updateStats();
        }

        function showInfo(elementId, message) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.className = 'result info';
            resultDiv.innerHTML = `‚ÑπÔ∏è <strong>INFO:</strong> ${message}`;
        }

        function updateStats() {
            document.getElementById('totalTests').textContent = testResults.total;
            document.getElementById('passedTests').textContent = testResults.passed;
            document.getElementById('failedTests').textContent = testResults.failed;

            // Usar getCustomTrainModels() que retorna un array
            const customModels = window.ConfigurationManager.getCustomTrainModels();
            const customConfigs = customModels ? customModels.length : 0;
            document.getElementById('customConfigs').textContent = customConfigs;

            const percentage = testResults.total > 0 ? (testResults.passed / testResults.total) * 100 : 0;
            document.getElementById('progressBar').style.width = percentage + '%';
        }

        // ====================================================================
        // TEST 1: TEMPLATES
        // ====================================================================
        function test1_1() {
            try {
                if (!window.TrainTemplates) {
                    throw new Error('TrainTemplates no est√° disponible');
                }

                const templates = window.TrainTemplates.getAll();
                if (templates.length !== 5) {
                    throw new Error(`Se esperaban 5 templates, se encontraron ${templates.length}`);
                }

                const names = templates.map(t => t.name).join(', ');
                showResult('result-1-1', true, `5 templates encontrados: ${names}`);
            } catch (error) {
                showResult('result-1-1', false, error.message);
            }
        }

        function test1_2() {
            try {
                const template = window.TrainTemplates.getTemplate('regional-3-coaches');
                const model = window.TrainTemplates.createFromTemplate('regional-3-coaches', 'Test Regional 3C');

                if (!model) {
                    throw new Error('No se pudo crear modelo desde template');
                }

                if (model.coaches.length !== 3) {
                    throw new Error(`Se esperaban 3 coches, se encontraron ${model.coaches.length}`);
                }

                showResult('result-1-2', true,
                    `Modelo creado correctamente: ${model.name} con ${model.coaches.length} coches`);
            } catch (error) {
                showResult('result-1-2', false, error.message);
            }
        }

        function test1_3() {
            try {
                const template = window.TrainTemplates.getTemplate('suburban-4-coaches');

                if (!template) {
                    throw new Error('Template Suburban no encontrado');
                }

                if (template.coaches.length !== 4) {
                    throw new Error(`Se esperaban 4 coches, se encontraron ${template.coaches.length}`);
                }

                // Verificar que tenga disposici√≥n 3+2 (6 posiciones por fila)
                const firstCoach = template.coaches[0];
                const firstRow = firstCoach.layout.find(section => section.type === 'seats');

                if (!firstRow || firstRow.positions[0].length !== 6) {
                    throw new Error('Disposici√≥n incorrecta, se esperaba 3+2 (6 posiciones)');
                }

                showResult('result-1-3', true,
                    `Template Suburbano verificado: 4 coches con disposici√≥n 3+2`);
            } catch (error) {
                showResult('result-1-3', false, error.message);
            }
        }

        // ====================================================================
        // TEST 2: TOOLTIPS
        // ====================================================================
        function test2_1() {
            try {
                // Verificar que las clases CSS existen creando elementos de prueba
                const testWrapper = document.createElement('div');
                testWrapper.className = 'tooltip-wrapper';
                document.body.appendChild(testWrapper);

                const testIcon = document.createElement('span');
                testIcon.className = 'tooltip-icon';
                document.body.appendChild(testIcon);

                // Verificar que los estilos se aplicaron
                const wrapperStyles = window.getComputedStyle(testWrapper);
                const iconStyles = window.getComputedStyle(testIcon);

                // Limpiar elementos de prueba
                testWrapper.remove();
                testIcon.remove();

                // Verificar que tienen estilos aplicados (display debe ser flex o inline-flex)
                const hasWrapperStyles = wrapperStyles.display === 'inline-flex' || wrapperStyles.display === 'flex';
                const hasIconStyles = iconStyles.display === 'inline-flex' ||
                                     iconStyles.backgroundColor !== 'rgba(0, 0, 0, 0)';

                if (!hasWrapperStyles && !hasIconStyles) {
                    throw new Error('Clases CSS de tooltips no encontradas o no aplicadas correctamente');
                }

                showResult('result-2-1', true,
                    `Estilos CSS de tooltips encontrados correctamente (wrapper: ${wrapperStyles.display}, icon: ${iconStyles.backgroundColor})`);
            } catch (error) {
                showResult('result-2-1', false, error.message);
            }
        }

        function test2_2() {
            try {
                showInfo('result-2-2',
                    'Wizard abierto. Verifica visualmente que aparezcan iconos "?" junto a los campos. Cierra el wizard cuando termines.');

                window.TrainModelWizard.open({
                    onComplete: () => {
                        showResult('result-2-2', true, 'Wizard completado correctamente');
                    },
                    onCancel: () => {
                        showInfo('result-2-2', 'Wizard cancelado por el usuario');
                    }
                });
            } catch (error) {
                showResult('result-2-2', false, error.message);
            }
        }

        function closeWizard() {
            const overlay = document.getElementById('train-wizard-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // ====================================================================
        // TEST 3: FLUJO COMPLETO
        // ====================================================================
        function test3_1() {
            try {
                const model = window.TrainTemplates.createFromTemplate('intercity-2-coaches', 'Test Intercity E2E');

                // Asegurar que el modelo tenga descripci√≥n (opcional pero recomendado)
                if (!model.description) {
                    model.description = 'Modelo de prueba creado desde template Intercity';
                }

                console.log('[Test 3.1] Modelo creado:', model);

                const result = window.ConfigurationManager.saveCustomTrainModel(model);

                console.log('[Test 3.1] Resultado de guardar:', result);

                if (!result || !result.success) {
                    const errorMsg = result ? (result.error || result.message) : 'saveCustomTrainModel no retorn√≥ un objeto v√°lido';
                    throw new Error(errorMsg || 'Error desconocido al guardar modelo');
                }

                showResult('result-3-1', true,
                    `Modelo "${model.name}" creado y guardado. ID: ${model.id}`);
            } catch (error) {
                console.error('[Test 3.1] Error:', error);
                showResult('result-3-1', false, error.message);
            }
        }

        function test3_2() {
            try {
                // Usar getCustomTrainModels() que retorna un array directamente
                const customModels = window.ConfigurationManager.getCustomTrainModels();
                const testModel = customModels.find(m => m.name === 'Test Intercity E2E');

                if (!testModel) {
                    throw new Error('Modelo de prueba no encontrado');
                }

                if (!testModel.custom) {
                    throw new Error('Modelo no est√° marcado como custom');
                }

                showResult('result-3-2', true,
                    `Modelo encontrado y verificado correctamente. Tiene ${testModel.coaches.length} coches.`);
            } catch (error) {
                showResult('result-3-2', false, error.message);
            }
        }

        // ====================================================================
        // TEST 4: INTEGRACI√ìN UI
        // ====================================================================
        function test4_1() {
            try {
                if (!window.ConfigurationManagerUI) {
                    throw new Error('ConfigurationManagerUI no disponible');
                }

                window.ConfigurationManagerUI.open();
                showResult('result-4-1', true,
                    'Gestor de Configuraciones abierto. Crea un modelo y verifica que puedas usar templates.');
            } catch (error) {
                showResult('result-4-1', false, error.message);
            }
        }

        function test4_2() {
            try {
                // No podemos verificar archivos del sistema de archivos desde el navegador
                // Pero podemos verificar que los scripts de templates est√©n cargados
                if (!window.TrainTemplates) {
                    throw new Error('TrainTemplates no est√° cargado');
                }

                showResult('result-4-2', true,
                    'Sistema de templates cargado correctamente. Verifica manualmente que USER_GUIDE.md existe en el proyecto.');
            } catch (error) {
                showResult('result-4-2', false, error.message);
            }
        }

        // ====================================================================
        // TEST 5: LIMPIEZA
        // ====================================================================
        function test5_1() {
            try {
                // Usar getCustomTrainModels() que retorna un array directamente
                const customModels = window.ConfigurationManager.getCustomTrainModels();
                let deleted = 0;

                customModels.forEach(model => {
                    if (model.name.startsWith('Test ')) {
                        window.ConfigurationManager.deleteCustomTrainModel(model.id);
                        deleted++;
                    }
                });

                showResult('result-5-1', true,
                    `${deleted} configuraciones de prueba eliminadas correctamente`);
                updateStats();
            } catch (error) {
                showResult('result-5-1', false, error.message);
            }
        }

        function resetAll() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esto eliminar√° TODAS las configuraciones personalizadas.')) {
                localStorage.removeItem('userTrainModels');
                localStorage.removeItem('userRoutes');
                localStorage.removeItem('userStops');
                testResults = { total: 0, passed: 0, failed: 0 };
                updateStats();
                alert('‚úÖ Todos los datos han sido eliminados. Recarga la p√°gina.');
            }
        }

        // ====================================================================
        // EJECUTAR TODOS LOS TESTS
        // ====================================================================
        async function runAllTests() {
            testResults = { total: 0, passed: 0, failed: 0 };

            console.log('üß™ Iniciando tests E2E...');

            // Test 1
            test1_1();
            await sleep(200);
            test1_2();
            await sleep(200);
            test1_3();
            await sleep(200);

            // Test 2
            test2_1();
            await sleep(200);

            // Test 3
            test3_1();
            await sleep(200);
            test3_2();
            await sleep(200);

            // Test 4
            test4_2();
            await sleep(200);

            console.log('‚úÖ Tests completados');
            updateStats();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Inicializar
        updateStats();
    </script>
</body>
</html>
